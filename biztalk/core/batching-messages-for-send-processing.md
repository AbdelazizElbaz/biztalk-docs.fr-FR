---
title: "Traitement par lot des Messages pour le traitement d’envoi | Documents Microsoft"
ms.custom: 
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: 
ms.suite: 
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: 7d9115ec-13bc-41a8-8928-57b168c95af4
caps.latest.revision: "6"
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: e87600bec54679688fae5084af3b4a1bde9ca807
ms.sourcegitcommit: cb908c540d8f1a692d01dc8f313e16cb4b4e696d
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 09/20/2017
---
# <a name="batching-messages-for-send-processing"></a><span data-ttu-id="d5a33-102">Traitement par lot des messages pour le traitement d'envoi</span><span class="sxs-lookup"><span data-stu-id="d5a33-102">Batching Messages for Send Processing</span></span>
## <a name="send-adapter-batch-management"></a><span data-ttu-id="d5a33-103">Gestion par lots de l'adaptateur d'envoi</span><span class="sxs-lookup"><span data-stu-id="d5a33-103">Send Adapter Batch Management</span></span>  
 <span data-ttu-id="d5a33-104">Lorsque vous utilisez des transactions côté envoi, la même transaction, créée par BizTalk Server et utilisée pour l'envoi vers le système cible, est utilisée pour la suppression du message correspondant une fois qu'il a été envoyé avec succès.</span><span class="sxs-lookup"><span data-stu-id="d5a33-104">When using transactions on the send side, the same transaction created by BizTalk Server and used for sending to the target system is used for the corresponding message deletion once it has been sent successfully.</span></span> <span data-ttu-id="d5a33-105">En cas d'échec, la transaction peut être interrompue, auquel cas la suppression est annulée et les données demeurent dans BizTalk Server et non dans le système cible.</span><span class="sxs-lookup"><span data-stu-id="d5a33-105">If anything fails, the transaction can be ended, in which case the deletion is aborted, and the data remains in BizTalk Server and not in the target system.</span></span> <span data-ttu-id="d5a33-106">Ceci évite la duplication des messages.</span><span class="sxs-lookup"><span data-stu-id="d5a33-106">This prevents duplication of messages.</span></span> <span data-ttu-id="d5a33-107">Les transactions ne sont prises en charge que pour les adaptateurs d'envoi asynchrones.</span><span class="sxs-lookup"><span data-stu-id="d5a33-107">Transactions are only supported for asynchronous send adapters.</span></span> <span data-ttu-id="d5a33-108">Vous ne devez pas utiliser de transactions pour les adaptateurs d'envoi synchrones.</span><span class="sxs-lookup"><span data-stu-id="d5a33-108">You should not use transactions with synchronous send adapters.</span></span>  
  
 <span data-ttu-id="d5a33-109">Mais l'adaptateur ne doit pas simplement mettre fin à la transaction; il doit également gérer correctement l'état des messages qui lui ont été donnés.</span><span class="sxs-lookup"><span data-stu-id="d5a33-109">But the adapter cannot just end the transaction; it must also handle correctly the state of the messages it was given.</span></span> <span data-ttu-id="d5a33-110">Plus précisément, l’adaptateur doit appeler les méthodes **renvoyer**, **MoveToNextTransport**, et **MoveToSuspendQ** manière appropriée selon le nombre de tentatives et si un transport secondaire n’est disponible.</span><span class="sxs-lookup"><span data-stu-id="d5a33-110">Specifically, the adapter should call the methods **Resubmit**, **MoveToNextTransport**, and **MoveToSuspendQ** appropriately depending upon the retry count and whether a backup transport is available.</span></span>  
  
 <span data-ttu-id="d5a33-111">Il est important de placer la **supprimer** et **SubmitResponse** opérations ensemble dans un lot qui utilise la même transaction.</span><span class="sxs-lookup"><span data-stu-id="d5a33-111">It is important to place the **Delete** and **SubmitResponse** operations together in a batch that uses the same transaction.</span></span> <span data-ttu-id="d5a33-112">En cas d'échec, le système met fin à la transaction (afin de garantir que les données ne sont envoyées qu'une seule fois à un système externe).</span><span class="sxs-lookup"><span data-stu-id="d5a33-112">Failure is handled by ending the transaction (to ensure that data is only submitted once to an external system).</span></span> <span data-ttu-id="d5a33-113">Mais vous souhaitez soumettre à nouveau ou appeler **MoveToNextTransport** pour renvoyer les message à BizTalk Server.</span><span class="sxs-lookup"><span data-stu-id="d5a33-113">But you still want to resubmit or call **MoveToNextTransport** for the message back on BizTalk Server.</span></span> <span data-ttu-id="d5a33-114">Pour ce faire, utilisez un lot normal (non transactionnel) distinct pour ces types d'opérations.</span><span class="sxs-lookup"><span data-stu-id="d5a33-114">To do this, use a separate normal (non-transactional) batch for these types of operations.</span></span>  
  
 <span data-ttu-id="d5a33-115">La figure suivante illustre l'utilisation de lots distincts pour les messages de réponse.</span><span class="sxs-lookup"><span data-stu-id="d5a33-115">The following figure shows the use of separate batches for response messages.</span></span>  
  
 <span data-ttu-id="d5a33-116">![À l’aide d’un lot distinct pour les messages de réponse](../core/media/eawp-seperatebatch.gif "EAWP_SeperateBatch")</span><span class="sxs-lookup"><span data-stu-id="d5a33-116">![Using a seperate batch for response messages](../core/media/eawp-seperatebatch.gif "EAWP_SeperateBatch")</span></span>  
  
## <a name="sorting-the-send-side-transactional-batches-by-endpoint"></a><span data-ttu-id="d5a33-117">Tri des lots de transactions côté envoi par point de terminaison</span><span class="sxs-lookup"><span data-stu-id="d5a33-117">Sorting the Send-Side Transactional Batches by Endpoint</span></span>  
 <span data-ttu-id="d5a33-118">Les lots de messages envoyés par BizTalk Server à l'adaptateur peuvent s'étendre sur plusieurs ports d'envoi (ou points de terminaison).</span><span class="sxs-lookup"><span data-stu-id="d5a33-118">Batches of messages sent by BizTalk Server to the adapter can span multiple send ports (or endpoints).</span></span> <span data-ttu-id="d5a33-119">Étant donné que l’adaptateur souhaite généralement avoir une transaction à un seul point de terminaison, l’adaptateur doit trier les messages basés sur le port d’envoi (**SPName** ou **OutboundTransportLocation**).</span><span class="sxs-lookup"><span data-stu-id="d5a33-119">Because the adapter typically wants to have a transaction to a single endpoint, the adapter must sort the messages based on send port (**SPName** or **OutboundTransportLocation**).</span></span> <span data-ttu-id="d5a33-120">En procédant ainsi, il peut créer une transaction qui ne concerne qu'un seul port d'envoi.</span><span class="sxs-lookup"><span data-stu-id="d5a33-120">By doing this, the adapter can create a transaction that spans only a particular send port.</span></span>  
  
 <span data-ttu-id="d5a33-121">Par exemple, lorsqu'un adaptateur d'envoi FTP reçoit un lot de messages de BizTalk Server, il obtient un lot mixte de messages destinés à tous les ports d'envoi FTP actuellement actifs.</span><span class="sxs-lookup"><span data-stu-id="d5a33-121">For example, when an FTP send adapter receives a batch of messages from BizTalk Server, it gets a mixed batch of messages for all the currently active FTP send ports.</span></span> <span data-ttu-id="d5a33-122">Ceci est dû au fait que l'API est basée sur un singleton, ce qui signifie qu'un seul adaptateur FTP est chargé et non un par port d'envoi.</span><span class="sxs-lookup"><span data-stu-id="d5a33-122">This happens because the API is singleton based, meaning that only a single FTP adapter is loaded, not one per send port.</span></span>  
  
 <span data-ttu-id="d5a33-123">L'adaptateur doit d'abord trier le lot de messages qui lui a été fourni par BizTalk Server en lots séparés, un par point de terminaison.</span><span class="sxs-lookup"><span data-stu-id="d5a33-123">The adapter must first sort the batch of messages it was given by BizTalk Server into separate batches, one for each endpoint.</span></span> <span data-ttu-id="d5a33-124">Ensuite, il peut traiter tour à tour chaque point de terminaison et générer probablement des lots de suppression pour chaque point de terminaison.</span><span class="sxs-lookup"><span data-stu-id="d5a33-124">Then it can deal with each endpoint in turn and will probably construct delete batches for each endpoint.</span></span> <span data-ttu-id="d5a33-125">Les classes réutilisables génériques de BaseAdapter dans l'exemple de code SDK fonctionnent de la même manière.</span><span class="sxs-lookup"><span data-stu-id="d5a33-125">The BaseAdapter generic reusable classes in the SDK sample code work in the same way.</span></span>  
  
## <a name="sorting-for-dynamic-send"></a><span data-ttu-id="d5a33-126">Tri pour l'envoi dynamique</span><span class="sxs-lookup"><span data-stu-id="d5a33-126">Sorting for Dynamic Send</span></span>  
 <span data-ttu-id="d5a33-127">Une orchestration BizTalk Server peut envoyer un message à un port qui n'a pas été configuré, à condition de fournir suffisamment d'informations de configuration dans l'en-tête du message et dans l'URL proprement dite.</span><span class="sxs-lookup"><span data-stu-id="d5a33-127">A BizTalk Server orchestration can send a message to a port that has not been configured as long as it provides sufficient configuration details in the message header and in the URL itself.</span></span> <span data-ttu-id="d5a33-128">BizTalk Server doit reconnaître le protocole de l'URL.</span><span class="sxs-lookup"><span data-stu-id="d5a33-128">BizTalk Server must recognize the protocol of the URL.</span></span>  
  
 <span data-ttu-id="d5a33-129">Lors du tri des messages, pensez à établir ce qui définit un point de terminaison.</span><span class="sxs-lookup"><span data-stu-id="d5a33-129">When sorting messages, you should take care to establish what defines an endpoint.</span></span> <span data-ttu-id="d5a33-130">Ceci est particulièrement vrai dans le cas d'un envoi dynamique.</span><span class="sxs-lookup"><span data-stu-id="d5a33-130">This is especially true in the case of a dynamic send.</span></span> <span data-ttu-id="d5a33-131">Si seule l'URI définit le point de terminaison, les choses sont simples.</span><span class="sxs-lookup"><span data-stu-id="d5a33-131">If only the URI defines the endpoint, then things are simple.</span></span> <span data-ttu-id="d5a33-132">Toutefois, dans une session FTP, les informations de connexion de l'utilisateur peuvent être utilisées par le serveur FTP pour définir le point de terminaison véritable.</span><span class="sxs-lookup"><span data-stu-id="d5a33-132">However, in an FTP session the user name logon details might be used by the FTP server to define the true endpoint.</span></span> <span data-ttu-id="d5a33-133">Dans ce cas, si l'adaptateur se connecte sous un nom de compte différent, il est possible qu'il soit connecté à un répertoire différent.</span><span class="sxs-lookup"><span data-stu-id="d5a33-133">In this case, if the adapter logs in as a different account, it may be connected to a different directory.</span></span>  
  
 <span data-ttu-id="d5a33-134">Dans certains cas, le point de terminaison véritable n’est pas connu jusqu'à ce que vous avez exécuté la commande Enterprise Single Sign-On (SSO) **ValidateAndRedeemTicket**.</span><span class="sxs-lookup"><span data-stu-id="d5a33-134">In some cases, the true endpoint is not known until you have run the Enterprise Single Sign-On (SSO) command **ValidateAndRedeemTicket**.</span></span>  
  
 <span data-ttu-id="d5a33-135">Dans le cas de MQSeries, il est possible de configurer l'utilisation ou non de transactions.</span><span class="sxs-lookup"><span data-stu-id="d5a33-135">In the case of MQSeries, the determination of whether to use transactions is configurable.</span></span> <span data-ttu-id="d5a33-136">En fonction de l'architecture et de l'utilisation d'un objet COM+ distant, il est préférable de considérer un point de terminaison transactionnel comme distinct d'un point de terminaison non transactionnel.</span><span class="sxs-lookup"><span data-stu-id="d5a33-136">Given the architecture and the use of a remote COM+ object, it is best to regard a transactional endpoint as distinct from a non-transactional endpoint.</span></span>  
  
 <span data-ttu-id="d5a33-137">Pour résumer, le tri des messages en lots pour des points de terminaison uniques est parfois une tâche non triviale, qui peut faire intervenir des étapes supplémentaires comme la prise en compte des valeurs de contexte ou même le résultat d'un appel au service d'authentification unique de l'entreprise.</span><span class="sxs-lookup"><span data-stu-id="d5a33-137">To summarize, sorting messages into their single endpoint batches is sometimes a nontrivial task and may involve such extra steps as considering the context values and even the result of a call to SSO.</span></span>  
  
## <a name="sorting-for-static-send"></a><span data-ttu-id="d5a33-138">Tri pour l'envoi statique</span><span class="sxs-lookup"><span data-stu-id="d5a33-138">Sorting for Static Send</span></span>  
 <span data-ttu-id="d5a33-139">Si le point de terminaison est configuré de manière statique, il existe un GUID unique pour le contexte du message appelé ID de port statique (SPID).</span><span class="sxs-lookup"><span data-stu-id="d5a33-139">If the endpoint is a statically configured endpoint there is a unique GUID on the message context called the static port ID (SPID).</span></span> <span data-ttu-id="d5a33-140">Cette valeur peut être utilisée pour le tri du point de terminaison.</span><span class="sxs-lookup"><span data-stu-id="d5a33-140">This value can be used for sorting the endpoint.</span></span> <span data-ttu-id="d5a33-141">Vous pouvez utiliser le code suivant pour la récupérer.</span><span class="sxs-lookup"><span data-stu-id="d5a33-141">The following code can be used to retrieve it:</span></span>  
  
```  
string spid = (string)message.Context.Read("SPID", "http://schemas.microsoft.com/BizTalk/2003/system-properties");  
```  
  
 <span data-ttu-id="d5a33-142">Ceci est pratique si on prend en compte les problèmes introduits par la structure de configuration basée sur la définition de schéma XML (XSD).</span><span class="sxs-lookup"><span data-stu-id="d5a33-142">This is helpful when you consider the problems introduced by the XML Schema Definition (XSD)-based configuration framework.</span></span> <span data-ttu-id="d5a33-143">Avec cette structure, une propriété peut faire partie de la clé du point de terminaison enfouie dans XML, dans une propriété de contexte unique.</span><span class="sxs-lookup"><span data-stu-id="d5a33-143">With this framework, you have a property that might be part of the endpoint key buried inside XML in a single context property.</span></span> <span data-ttu-id="d5a33-144">Si vous disposez d'un SPID sur le contexte, vous pouvez l'utiliser pour le tri du lot.</span><span class="sxs-lookup"><span data-stu-id="d5a33-144">If you have a SPID on the context, you can use that as a way to sort the batch.</span></span> <span data-ttu-id="d5a33-145">Sinon, vous procédez à un envoi dynamique et vous devez construire une clé alternative qui vous permettra de trier le lot.</span><span class="sxs-lookup"><span data-stu-id="d5a33-145">Otherwise you are doing a dynamic send and you need to construct an alternative key with which to sort the batch.</span></span>  
  
 <span data-ttu-id="d5a33-146">L'illustration suivante montre le tri des messages par point de terminaison.</span><span class="sxs-lookup"><span data-stu-id="d5a33-146">The following figure shows message sorting by endpoint.</span></span>  
  
 <span data-ttu-id="d5a33-147">![Tri des messages par point de terminaison](../core/media/eawp-sortbatch.gif "EAWP_SortBatch")</span><span class="sxs-lookup"><span data-stu-id="d5a33-147">![Sorting messages by endpoint](../core/media/eawp-sortbatch.gif "EAWP_SortBatch")</span></span>  
  
 <span data-ttu-id="d5a33-148">Rappelez-vous que le nombre de tentatives pour un message n'est pas conscient de la réussite ou de l'échec du lot.</span><span class="sxs-lookup"><span data-stu-id="d5a33-148">Remember that the retry count of a message is not aware of the success or failure of a batch.</span></span> <span data-ttu-id="d5a33-149">Côté envoi, un lot de messages peut échouer car quelques messages du lot ont échoué.</span><span class="sxs-lookup"><span data-stu-id="d5a33-149">On the send side, a batch of messages may fail because a few messages in the batch have failed.</span></span> <span data-ttu-id="d5a33-150">L'adaptateur doit effectuer une détermination pour chaque message qu'il reçoit.</span><span class="sxs-lookup"><span data-stu-id="d5a33-150">The adapter must make a determination for every message that it receives.</span></span> <span data-ttu-id="d5a33-151">Dans un scénario de lot en échec, vous pouvez supposer que tous les messages ont été soumis à nouveau.</span><span class="sxs-lookup"><span data-stu-id="d5a33-151">In the failed batch scenario, you might assume that every message is resubmitted.</span></span> <span data-ttu-id="d5a33-152">Toutefois, si tous les messages d'un lot en échec sont soumis à nouveau, le nombre de tentatives (qui est géré par le moteur BizTalk Server) est incrémenté à tort pour les messages réussis par ce qu'ils se trouvaient dans le même lot que les messages en échec.</span><span class="sxs-lookup"><span data-stu-id="d5a33-152">However, if all the messages in a failing batch are resubmitted, the retry count (which is maintained by the BizTalk Server engine) is incorrectly incremented even for the successful messages because they happen to be in the same batch as the failed messages.</span></span> <span data-ttu-id="d5a33-153">Dans cette situation, un adaptateur peut reformer le lot sortant et représenter les messages réussis sur le système externe.</span><span class="sxs-lookup"><span data-stu-id="d5a33-153">In this case, an adapter could reform the outbound batch and retry the successful messages against the external system.</span></span>