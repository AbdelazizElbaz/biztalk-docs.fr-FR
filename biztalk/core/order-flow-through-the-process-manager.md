---
title: Commande flux via le Gestionnaire de processus | Documents Microsoft
ms.custom: 
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: 
ms.suite: 
ms.tgt_pltfrm: 
ms.topic: article
helpviewer_keywords:
- process management solution tutorial, processing
- processing, processing logic
ms.assetid: e2b51eff-44b5-440f-a7d1-0872543e5f27
caps.latest.revision: "30"
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 8556bce43ba4a951d0045d22f76d4bd222fcd8f2
ms.sourcegitcommit: cb908c540d8f1a692d01dc8f313e16cb4b4e696d
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 09/20/2017
---
# <a name="order-flow-through-the-process-manager"></a><span data-ttu-id="4fea7-102">Flux de commandes par le biais du Gestionnaire de processus</span><span class="sxs-lookup"><span data-stu-id="4fea7-102">Order Flow through the Process Manager</span></span>
<span data-ttu-id="4fea7-103">Cette section décrit comment le Southridge Video commande Gestionnaire de processus, le **OrderManager** d’orchestration, les commandes de processus.</span><span class="sxs-lookup"><span data-stu-id="4fea7-103">This section describes how the Southridge Video order process manager, the **OrderManager** orchestration, processes orders.</span></span> <span data-ttu-id="4fea7-104">Cette section suit une nouvelle commande dans l'orchestration.</span><span class="sxs-lookup"><span data-stu-id="4fea7-104">This section follows a new order through the orchestration.</span></span> <span data-ttu-id="4fea7-105">La section explique également comment l'orchestration gère les mises à jour des commandes.</span><span class="sxs-lookup"><span data-stu-id="4fea7-105">The section also discusses how the orchestration handles updates to orders.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="4fea7-106">La solution de gestionnaire de processus d'entreprise inclut un seul gestionnaire de processus, bien qu'il soit écrit qu'il peut utiliser plusieurs types de gestionnaires.</span><span class="sxs-lookup"><span data-stu-id="4fea7-106">The business process manager solution includes only one process manager although it is written so that it can use more than one type of manager.</span></span>  
  
 <span data-ttu-id="4fea7-107">Le **OrderManager** orchestration coordonne les orchestrations subordonnées qui implémentent le processus d’entreprise pour gérer la commande.</span><span class="sxs-lookup"><span data-stu-id="4fea7-107">The **OrderManager** orchestration coordinates subordinate orchestrations that implement the business process to handle the order.</span></span> <span data-ttu-id="4fea7-108">Le **OrderManager** envoie la commande en deux étapes qui, combinés, valider la commande, envoyer les informations au groupe d’installations, l’ordre d’envoi au système de commande via les composants de la communication à distance et mettre à jour l’historique des commandes.</span><span class="sxs-lookup"><span data-stu-id="4fea7-108">The **OrderManager** sends the order through two stages which, combined, validate the order, send the information to the facilities group, send the order to the order system through remoting components, and update the order history.</span></span> <span data-ttu-id="4fea7-109">Vous pouvez ajouter, supprimer ou modifier ces étapes sans devoir modifier le **OrderManager**.</span><span class="sxs-lookup"><span data-stu-id="4fea7-109">You can add, delete, or modify these stages without having to change the **OrderManager**.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="4fea7-110">En raison de la taille et la portée de la **OrderManager** orchestration, vous voudrez lire cette section avec l’orchestration ouverte dans Microsoft Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="4fea7-110">Because of the size and scope of the **OrderManager** orchestration, you may want to read this section with the orchestration open in Microsoft Visual Studio.</span></span>  
  
## <a name="order-manager-structure"></a><span data-ttu-id="4fea7-111">Structure du gestionnaire de commandes</span><span class="sxs-lookup"><span data-stu-id="4fea7-111">Order Manager Structure</span></span>  
 <span data-ttu-id="4fea7-112">Le **OrderManager** orchestration commence par une forme réception qui active l’orchestration.</span><span class="sxs-lookup"><span data-stu-id="4fea7-112">The **OrderManager** orchestration begins with a receive shape that activates the orchestration.</span></span> <span data-ttu-id="4fea7-113">Le diagramme suivant illustre la structure générale de la **OrderManager** orchestration.</span><span class="sxs-lookup"><span data-stu-id="4fea7-113">The following diagram shows the general structure of the **OrderManager** orchestration.</span></span>  
  
 <span data-ttu-id="4fea7-114">![Schéma du Gestionnaire de commandes](../core/media/ordermanagerblockdiagram.gif "OrderManagerBlockDiagram")</span><span class="sxs-lookup"><span data-stu-id="4fea7-114">![Block Diagram of Order Manager](../core/media/ordermanagerblockdiagram.gif "OrderManagerBlockDiagram")</span></span>  
  
 <span data-ttu-id="4fea7-115">La première forme Réception donne deux branches principales.</span><span class="sxs-lookup"><span data-stu-id="4fea7-115">The first receive shape leads to two main branches.</span></span> <span data-ttu-id="4fea7-116">Une branche, à droite, traite les nouvelles commandes.</span><span class="sxs-lookup"><span data-stu-id="4fea7-116">One branch, the right one, processes new orders.</span></span> <span data-ttu-id="4fea7-117">La branche de gauche gère les annulations de commande.</span><span class="sxs-lookup"><span data-stu-id="4fea7-117">The left branch, handles order cancellations.</span></span> <span data-ttu-id="4fea7-118">Il accepte l’entrée d’utilisateur, il est possible pour le **OrderManager** pour recevoir une annulation de commande après une commande est déjà terminée.</span><span class="sxs-lookup"><span data-stu-id="4fea7-118">Because it accepts user input, it is possible for the **OrderManager** to receive an order cancellation after an order has already completed.</span></span> <span data-ttu-id="4fea7-119">C'est le cas géré par la branche principale à gauche.</span><span class="sxs-lookup"><span data-stu-id="4fea7-119">This is the case the left main branch handles.</span></span> <span data-ttu-id="4fea7-120">La branche gère l'annulation isolée en définissant des indicateurs pour terminer le traitement et en ajoutant un avertissement au journal des événements.</span><span class="sxs-lookup"><span data-stu-id="4fea7-120">The branch handles the isolated cancellation by setting flags for terminating processing and by adding a warning to the event log.</span></span> <span data-ttu-id="4fea7-121">L'orchestration gère les annulations de commande qui arrivent tandis qu'une commande est en cours de traitement dans la branche de droite.</span><span class="sxs-lookup"><span data-stu-id="4fea7-121">The orchestration handles order cancellations that arrive while an order is being processed inside the right-hand branch.</span></span>  
  
 <span data-ttu-id="4fea7-122">La branche de traitement de commande effectue une initialisation, puis entre dans deux boucles imbriquées.</span><span class="sxs-lookup"><span data-stu-id="4fea7-122">The order processing branch does some initialization and then enters two nested loops.</span></span> <span data-ttu-id="4fea7-123">La boucle externe s'exécute une seule fois pour chaque étape du traitement de commande.</span><span class="sxs-lookup"><span data-stu-id="4fea7-123">The outer loop runs once for each stage in the order processing.</span></span> <span data-ttu-id="4fea7-124">La boucle interne s'exécute lors du traitement de l'étape.</span><span class="sxs-lookup"><span data-stu-id="4fea7-124">The inner loop runs while the stage is processing.</span></span> <span data-ttu-id="4fea7-125">Le gestionnaire de commandes recherche également de possibles mises à jour de la commande à l'intérieur de la boucle interne.</span><span class="sxs-lookup"><span data-stu-id="4fea7-125">The order manager also listens for possible updates to the order inside the inner loop.</span></span> <span data-ttu-id="4fea7-126">Une fois que les boucles s'arrêtent, le gestionnaire de commandes envoie un message d'achèvement.</span><span class="sxs-lookup"><span data-stu-id="4fea7-126">After the loops terminate, the order manager sends a completion message.</span></span>  
  
 <span data-ttu-id="4fea7-127">Les étapes de traitement de commande utilisent des ports dynamiques, d’autocorrélation pour communiquer avec le **OrderManager** orchestration.</span><span class="sxs-lookup"><span data-stu-id="4fea7-127">The order processing stages use dynamic, self-correlating ports to communicate back to the **OrderManager** orchestration.</span></span> <span data-ttu-id="4fea7-128">Cela simplifie la corrélation de le **OrderManager** avec les instances des étapes car elle élimine la nécessité d’utiliser un ensemble de corrélations.</span><span class="sxs-lookup"><span data-stu-id="4fea7-128">This simplifies correlation of the **OrderManager** with the stage instances because it eliminates the need to use a correlation set.</span></span> <span data-ttu-id="4fea7-129">Pour plus d’informations sur les ports d’autocorrélation, consultez [liaisons de Port](../core/port-bindings.md).</span><span class="sxs-lookup"><span data-stu-id="4fea7-129">For more information about self-correlating ports, see [Port Bindings](../core/port-bindings.md).</span></span>  
  
## <a name="receiving-orders"></a><span data-ttu-id="4fea7-130">Réception de commandes</span><span class="sxs-lookup"><span data-stu-id="4fea7-130">Receiving Orders</span></span>  
 <span data-ttu-id="4fea7-131">Le **OrderManager** reçoit des messages de commande à partir de la **OrderBroker** orchestration via le **FromBrokerPort** port.</span><span class="sxs-lookup"><span data-stu-id="4fea7-131">The **OrderManager** receives order messages from the **OrderBroker** orchestration through the **FromBrokerPort** port.</span></span> <span data-ttu-id="4fea7-132">Ce port est lié directement à la base de données MessageBox.</span><span class="sxs-lookup"><span data-stu-id="4fea7-132">This port is bound directly to the MessageBox database.</span></span> <span data-ttu-id="4fea7-133">L’orchestration a deux **réception** formes connectées au port : un pour les nouvelles commandes et un pour mettre à jour les commandes.</span><span class="sxs-lookup"><span data-stu-id="4fea7-133">The orchestration has two **Receive** shapes connected to the port: one for new orders and one for updated orders.</span></span>  
  
 <span data-ttu-id="4fea7-134">Le **OrderManger** détermine les messages à traiter en fonction d’une expression de filtre.</span><span class="sxs-lookup"><span data-stu-id="4fea7-134">The **OrderManger** determines which messages to process based on a filter expression.</span></span> <span data-ttu-id="4fea7-135">L’expression de filtre teste la valeur dans le champ d’état de message et le champ de type de gestionnaire de commande, **OrderMgrType**.</span><span class="sxs-lookup"><span data-stu-id="4fea7-135">The filter expression tests the value in the message status field and the order manager type field, **OrderMgrType**.</span></span> <span data-ttu-id="4fea7-136">Si le champ d’état est égal à ACCEPTED et **OrderMgrType** est CABLEORDER, la commande est nouvelle et destinée à ce gestionnaire de processus.</span><span class="sxs-lookup"><span data-stu-id="4fea7-136">If the status field is equal to ACCEPTED, and the **OrderMgrType** is CABLEORDER, the order is new and intended for this process manager.</span></span>  
  
 <span data-ttu-id="4fea7-137">La nouvelle commande active une nouvelle instance de l'orchestration.</span><span class="sxs-lookup"><span data-stu-id="4fea7-137">The new order activates a new instance of the orchestration.</span></span> <span data-ttu-id="4fea7-138">Le **OrderManager** vérifie ensuite le type de la demande dans un **décision** forme.</span><span class="sxs-lookup"><span data-stu-id="4fea7-138">The **OrderManager** next checks the type of the request in a **Decision** shape.</span></span> <span data-ttu-id="4fea7-139">Si le type est Terminer, l'orchestration exécute la branche de gauche et met fin à la commande.</span><span class="sxs-lookup"><span data-stu-id="4fea7-139">If the type is Terminate, the orchestration executes the left-hand branch and terminates the order.</span></span> <span data-ttu-id="4fea7-140">Dans le cas contraire, l'orchestration procède au traitement de la commande.</span><span class="sxs-lookup"><span data-stu-id="4fea7-140">Otherwise, the orchestration proceeds with processing the order.</span></span> <span data-ttu-id="4fea7-141">Notez que cela inclut la recherche de messages suivants liés à cette commande particulière.</span><span class="sxs-lookup"><span data-stu-id="4fea7-141">Notice that this includes listening for subsequent messages related to this particular order.</span></span>  
  
## <a name="initialization-for-new-orders"></a><span data-ttu-id="4fea7-142">Initialisation de nouvelles commandes</span><span class="sxs-lookup"><span data-stu-id="4fea7-142">Initialization for New Orders</span></span>  
 <span data-ttu-id="4fea7-143">Après le **OrderManager** orchestration reçoit un message initial et commence la branche principale de droite, il obtient ses informations de configuration à partir de la **SSOConfigStore**.</span><span class="sxs-lookup"><span data-stu-id="4fea7-143">After the **OrderManager** orchestration receives an initial message and begins the main right-hand branch, it gets its configuration information from the **SSOConfigStore**.</span></span> <span data-ttu-id="4fea7-144">Pour cela, via un objet singleton défini dans le **utilitaires** assembly.</span><span class="sxs-lookup"><span data-stu-id="4fea7-144">It does this through a singleton object defined in the **Utilities** assembly.</span></span> <span data-ttu-id="4fea7-145">Les valeurs de configuration sont les propriétés de l'objet.</span><span class="sxs-lookup"><span data-stu-id="4fea7-145">The configuration values are properties of the object.</span></span> <span data-ttu-id="4fea7-146">L'objet gère un cache local des valeurs de configuration, similaire à la solution d'architecture orientée services.</span><span class="sxs-lookup"><span data-stu-id="4fea7-146">The object manages a local cache of the configuration values similar to the Service Oriented Architecture solution.</span></span> <span data-ttu-id="4fea7-147">Pour plus d’informations sur l’objet singleton, consultez [à l’aide de l’authentification unique efficacement dans la Solution de gestion des processus métier](../core/using-sso-efficiently-in-the-business-process-management-solution.md).</span><span class="sxs-lookup"><span data-stu-id="4fea7-147">For more information about the singleton object, see [Using SSO Efficiently in the Business Process Management Solution](../core/using-sso-efficiently-in-the-business-process-management-solution.md).</span></span>  
  
 <span data-ttu-id="4fea7-148">Comme la solution orientée services, la solution de gestion des processus d'entreprise utilise le magasin des secrets car il est présent lorsque BizTalk est installé, SSO met en cache les informations de configuration afin que les valeurs soient immédiatement disponibles et il peut protéger des informations, telles que des chaînes de connexion à la base de données et des mots de passe.</span><span class="sxs-lookup"><span data-stu-id="4fea7-148">Like the Service Oriented solution, the Business Process Management solution uses the secret store because it is present whenever BizTalk is installed, SSO caches the configuration information so that the values are readily available, and it can protect information such as database connection strings and passwords.</span></span> <span data-ttu-id="4fea7-149">Pour toutes ces raisons, le magasin des secrets est un bon endroit pour les informations de configuration, même si les authentifications uniques ne sont pas utilisées pour gérer les connexions aux applications principales.</span><span class="sxs-lookup"><span data-stu-id="4fea7-149">For all of these reasons, the secret store would be a good place for the configuration information even if Single Sign-On weren't being used for managing connections to the backend applications.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="4fea7-150">L'orchestration extrait les informations de configuration avant de commencer le traitement.</span><span class="sxs-lookup"><span data-stu-id="4fea7-150">The orchestration retrieves configuration information before starting processing.</span></span> <span data-ttu-id="4fea7-151">Cela garantit que l'orchestration utilise la même configuration si elle est en attente et, ultérieurement, réalimentée.</span><span class="sxs-lookup"><span data-stu-id="4fea7-151">This ensures the orchestration uses the same configuration if it is dehydrated and, later, rehydrated.</span></span> <span data-ttu-id="4fea7-152">Pour plus d’informations sur la mise en attente, consultez [mise en attente de l’Orchestration et la réactivation](../core/orchestration-dehydration-and-rehydration.md).</span><span class="sxs-lookup"><span data-stu-id="4fea7-152">For more information about dehydration, see [Orchestration Dehydration and Rehydration](../core/orchestration-dehydration-and-rehydration.md).</span></span>  
  
 <span data-ttu-id="4fea7-153">Le Gestionnaire de commandes utilise une valeur des données de configuration : **TotalStages**, le nombre total d’étapes dans l’ordre de la gestion des processus.</span><span class="sxs-lookup"><span data-stu-id="4fea7-153">The order manager uses one value from the configuration data: **TotalStages**, the total number of stages in the order handling process.</span></span> <span data-ttu-id="4fea7-154">Le gestionnaire affecte cette valeur à une variable locale, **numStages**.</span><span class="sxs-lookup"><span data-stu-id="4fea7-154">The manager assigns this value to a local variable, **numStages**.</span></span> <span data-ttu-id="4fea7-155">Il définit également les deux autres variables connectées à la boucle externe, **étape** et **arrêter**.</span><span class="sxs-lookup"><span data-stu-id="4fea7-155">It also sets two more variables connected to the outer loop, **stage** and **stop**.</span></span> <span data-ttu-id="4fea7-156">Le **étape** indique l’étape actuelle et est le compteur de la boucle externe ; **arrêter** la valeur d’arrêt.</span><span class="sxs-lookup"><span data-stu-id="4fea7-156">The **stage** indicates the current stage and is the counter for the outer loop; **stop** the stopping value.</span></span>  
  
 <span data-ttu-id="4fea7-157">Enfin, le gestionnaire définit les **orderStatus** variable Started et entre dans la boucle de traitement externe.</span><span class="sxs-lookup"><span data-stu-id="4fea7-157">Finally, the manager sets the **orderStatus** variable to STARTED and enters the outer processing loop.</span></span>  
  
## <a name="new-order-processing-loops"></a><span data-ttu-id="4fea7-158">Boucles de traitement de nouvelles commandes</span><span class="sxs-lookup"><span data-stu-id="4fea7-158">New Order Processing Loops</span></span>  
 <span data-ttu-id="4fea7-159">La boucle externe s’exécute en tant que la valeur de la **étape** variable est inférieure à la valeur de la **numStages** variable.</span><span class="sxs-lookup"><span data-stu-id="4fea7-159">The outer loop runs as long as the value of the **stage** variable is less than the value of the **numStages** variable.</span></span> <span data-ttu-id="4fea7-160">La boucle externe dirige le traitement pour chaque étape.</span><span class="sxs-lookup"><span data-stu-id="4fea7-160">The outer loops drives the processing for each stage.</span></span> <span data-ttu-id="4fea7-161">La boucle interne s'exécute tant qu'une étape est toujours en cours de traitement.</span><span class="sxs-lookup"><span data-stu-id="4fea7-161">The inner loop runs so long as a stage is still being processed.</span></span> <span data-ttu-id="4fea7-162">Elle recherche également les modifications éventuellement apportées à la commande.</span><span class="sxs-lookup"><span data-stu-id="4fea7-162">It also listens for possible changes to the order.</span></span>  
  
### <a name="outer-loop"></a><span data-ttu-id="4fea7-163">Boucle externe</span><span class="sxs-lookup"><span data-stu-id="4fea7-163">Outer Loop</span></span>  
 <span data-ttu-id="4fea7-164">L’orchestration commence la boucle externe en attribuant le message reçu (**NewOrderMgrMsg**) à une variable, **OrderMgrMsg**.</span><span class="sxs-lookup"><span data-stu-id="4fea7-164">The orchestration begins the outer loop by assigning the received message (**NewOrderMgrMsg**) to a variable, **OrderMgrMsg**.</span></span> <span data-ttu-id="4fea7-165">Elle copie ensuite l'étape et l'état dans la partie de routage du message.</span><span class="sxs-lookup"><span data-stu-id="4fea7-165">It then copies the stage and status to the routing part of the message.</span></span> <span data-ttu-id="4fea7-166">L’orchestration définit également l’adresse de retour dans le message à l’adresse de la **StageCompletionPort**:</span><span class="sxs-lookup"><span data-stu-id="4fea7-166">The orchestration also sets the return address in the message to the address of the **StageCompletionPort**:</span></span>  
  
```  
OrderMgrMsg.RoutingPart.OrderMgrReturnAddress =   
       StageCompletionPort(Microsoft.XLANGs.BaseTypes.Address);  
```  
  
 <span data-ttu-id="4fea7-167">L’orchestration envoie la commande à la **StagePort**, un port de sollicitation-réponse.</span><span class="sxs-lookup"><span data-stu-id="4fea7-167">The orchestration then sends the order to the **StagePort**, a solicit-response port.</span></span> <span data-ttu-id="4fea7-168">Puis, l'orchestration attend un accusé de réception de l'étape, indiquant que le traitement de commande a démarré.</span><span class="sxs-lookup"><span data-stu-id="4fea7-168">The orchestration then waits for an acknowledgement from the stage that order processing has started.</span></span> <span data-ttu-id="4fea7-169">L’étape envoie un **OrderAck** message lorsqu’il démarre le traitement de la commande.</span><span class="sxs-lookup"><span data-stu-id="4fea7-169">The stage sends an **OrderAck** message when it starts processing the order.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="4fea7-170">Le **OrderAck** message est un des nombreux dans la solution définie par les classes .NET plutôt qu’un schéma.</span><span class="sxs-lookup"><span data-stu-id="4fea7-170">The **OrderAck** message is one of several in the solution defined by .NET classes rather than a schema.</span></span> <span data-ttu-id="4fea7-171">Pour plus d’informations sur l’utilisation de classes .NET pour définir des messages, consultez [construction de Messages dans le Code utilisateur](../core/constructing-messages-in-user-code.md).</span><span class="sxs-lookup"><span data-stu-id="4fea7-171">For more information about using .NET classes to define messages, see [Constructing Messages in User Code](../core/constructing-messages-in-user-code.md).</span></span>  
  
 <span data-ttu-id="4fea7-172">Lorsque l’orchestration reçoit l’accusé de réception, il attribue l’étape à la **currentStage** variable et entre dans la boucle interne.</span><span class="sxs-lookup"><span data-stu-id="4fea7-172">When the orchestration receives the acknowledgement, it assigns the stage to the **currentStage** variable and enters the inner loop.</span></span>  
  
### <a name="inner-loop"></a><span data-ttu-id="4fea7-173">Boucle interne</span><span class="sxs-lookup"><span data-stu-id="4fea7-173">Inner Loop</span></span>  
 <span data-ttu-id="4fea7-174">La boucle interne s’exécute tant que la **currentStage** variable est égale à la **étape** variable ; c'est-à-dire, à condition que l’étape actuelle est en cours de traitement.</span><span class="sxs-lookup"><span data-stu-id="4fea7-174">The inner loop runs as long as the **currentStage** variable is equal to the **stage** variable; that is, as long as the current stage is being processed.</span></span> <span data-ttu-id="4fea7-175">Le corps de la boucle est un **écouter** forme avec trois **réception** formes.</span><span class="sxs-lookup"><span data-stu-id="4fea7-175">The body of the loop is a **Listen** shape with three **Receive** shapes.</span></span> <span data-ttu-id="4fea7-176">La forme la plus à gauche dans l’orchestration, **demande d’ordre**, fait partie du mécanisme de mise à jour de commande, décrit dans la section suivante.</span><span class="sxs-lookup"><span data-stu-id="4fea7-176">The leftmost shape in the orchestration, **Order Request**, is part of the order update mechanism, described in the next section.</span></span>  
  
 <span data-ttu-id="4fea7-177">Lorsqu’une commande de fin de l’étape de traitement, il envoie un message à la **StageCompletion** port de la **OrderManager** orchestration.</span><span class="sxs-lookup"><span data-stu-id="4fea7-177">When an order processing stage finishes, it sends a message to the **StageCompletion** port of the **OrderManager** orchestration.</span></span> <span data-ttu-id="4fea7-178">Si l’étape s’arrête brusquement en raison d’une erreur, il envoie un **TerminatedMessage**.</span><span class="sxs-lookup"><span data-stu-id="4fea7-178">If the stage abruptly terminates due to an error, it sends a **TerminatedMessage**.</span></span> <span data-ttu-id="4fea7-179">Dans ce cas, le **OrderManager** lève une exception.</span><span class="sxs-lookup"><span data-stu-id="4fea7-179">In this case, the **OrderManager** throws an exception.</span></span> <span data-ttu-id="4fea7-180">Le Gestionnaire d’exceptions le plus externe intercepte l’exception et envoie un message d’erreur pour le **OperatorPort**.</span><span class="sxs-lookup"><span data-stu-id="4fea7-180">The outermost exception handler catches the exception and sends an error message to the **OperatorPort**.</span></span>  
  
 <span data-ttu-id="4fea7-181">Si l’étape envoie un **OrderMgrMsg**, le **OrderManager** incrémente le **étape** variable.</span><span class="sxs-lookup"><span data-stu-id="4fea7-181">If the stage sends an **OrderMgrMsg**, the **OrderManager** increments the **stage** variable.</span></span> <span data-ttu-id="4fea7-182">S’il existe plusieurs étapes (stage inférieur ou égal à numStages), les orchestrations définit l’état de la commande **OrderMgrMsg** sur STAGE_n_COMPLETED, où n est le numéro de l’étape actuelle.</span><span class="sxs-lookup"><span data-stu-id="4fea7-182">If there are more stages (stage less than or equal to numStages), the orchestrations sets the order status in **OrderMgrMsg** to STAGE_n_COMPLETED where n is the number of the current stage.</span></span> <span data-ttu-id="4fea7-183">S'il n'y a pas d'étape supplémentaire, elle définit l'état de la commande sur COMPLETED et quitte les boucles.</span><span class="sxs-lookup"><span data-stu-id="4fea7-183">If there are no more stages, it sets the order status to COMPLETED and exits both loops.</span></span>  
  
## <a name="order-updates"></a><span data-ttu-id="4fea7-184">Mises à jour des commandes</span><span class="sxs-lookup"><span data-stu-id="4fea7-184">Order Updates</span></span>  
 <span data-ttu-id="4fea7-185">Le **OrderManager** orchestration écoute les mises à jour à l’intérieur de la boucle de traitement interne.</span><span class="sxs-lookup"><span data-stu-id="4fea7-185">The **OrderManager** orchestration listens for order updates inside the inner processing loop.</span></span> <span data-ttu-id="4fea7-186">Notez que la **réception** mettre en forme utilise pour ce faire, **OrderRequest**, utilise également le **FromBrokerPort**.</span><span class="sxs-lookup"><span data-stu-id="4fea7-186">Notice that the **Receive** shape it uses for this, **OrderRequest**, also uses the **FromBrokerPort**.</span></span> <span data-ttu-id="4fea7-187">L'utilisation d'une seconde forme Réception sur le même port dans une boucle, combinée à des ensembles de corrélations, crée un modèle BizTalk Server courant, le modèle de convoi.</span><span class="sxs-lookup"><span data-stu-id="4fea7-187">The use of a second receive shape on the same port inside a loop, combined with correlation sets, forms a common BizTalk Server pattern, the convoy pattern.</span></span> <span data-ttu-id="4fea7-188">Vous utilisez le modèle de convoi pour garantir que la même instance d'une orchestration traite le premier message et les messages suivants connectés à une opération particulière.</span><span class="sxs-lookup"><span data-stu-id="4fea7-188">You use the convoy pattern to ensure that the same instance of an orchestration processes the first and subsequent messages connected with a particular operation.</span></span>  
  
 <span data-ttu-id="4fea7-189">Lorsque le gestionnaire de commandes reçoit le premier message connecté à une commande, il initialise deux ensembles de corrélations.</span><span class="sxs-lookup"><span data-stu-id="4fea7-189">When the order manager receives the first message connected to an order, it initializes two correlation sets.</span></span> <span data-ttu-id="4fea7-190">La première, **OrderCorrelation**, utilise l’ID de client (**CustID**) et l’ID de commande (**OrderID**).</span><span class="sxs-lookup"><span data-stu-id="4fea7-190">The first, **OrderCorrelation**, uses the customer ID (**CustID**) and order ID (**OrderID**).</span></span> <span data-ttu-id="4fea7-191">Le gestionnaire de commandes partage cette corrélation avec les étapes de traitement de la commande.</span><span class="sxs-lookup"><span data-stu-id="4fea7-191">The order manager shares this correlation with the order processing stages.</span></span> <span data-ttu-id="4fea7-192">La seconde corrélation est la corrélation de convoi, **OrderConvoyCorrelation**, qui utilise l’état de la commande (**état**) en plus de l’ID du client et l’ID de commande.</span><span class="sxs-lookup"><span data-stu-id="4fea7-192">The second correlation is the convoy correlation, **OrderConvoyCorrelation**, which uses the order status (**Status**) in addition to the customer ID and order ID.</span></span> <span data-ttu-id="4fea7-193">Le **OrderRequestReceive** utilise la forme **OrderConvoyCorrelation** comme un ensemble de corrélations suivant.</span><span class="sxs-lookup"><span data-stu-id="4fea7-193">The **OrderRequestReceive** shape uses **OrderConvoyCorrelation** as a Following Correlation Set.</span></span> <span data-ttu-id="4fea7-194">Cette définition de la configuration de la corrélation garantit que l'instance du gestionnaire de commandes travaillant sur une commande particulière reçoit les modifications éventuelles.</span><span class="sxs-lookup"><span data-stu-id="4fea7-194">Setting the correlation set up this way ensures that the instance of the order manager working on a particular order receives any changes.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="4fea7-195">Rappelez-vous qu'un ensemble de corrélations est un regroupement de propriétés de message utilisées pour déterminer si un message appartient ou non à une instance donnée d'une orchestration.</span><span class="sxs-lookup"><span data-stu-id="4fea7-195">Recall that a correlation set is a grouping of message properties used to determine whether or not a message belongs to a given instance of an orchestration.</span></span> <span data-ttu-id="4fea7-196">Pour plus d’informations, consultez [à l’aide de corrélations dans les Orchestrations](../core/using-correlations-in-orchestrations.md).</span><span class="sxs-lookup"><span data-stu-id="4fea7-196">For more information, see [Using Correlations in Orchestrations](../core/using-correlations-in-orchestrations.md).</span></span>  
  
 <span data-ttu-id="4fea7-197">Lorsque le **OrderManager** reçoit un message d’une commande, il vérifie tout d’abord le type de demande.</span><span class="sxs-lookup"><span data-stu-id="4fea7-197">When the **OrderManager** receives a subsequent message for an order, it first tests the type of request.</span></span> <span data-ttu-id="4fea7-198">Si le type de demande est TERMINATE, la forme Décision exécute la branche Terminer.</span><span class="sxs-lookup"><span data-stu-id="4fea7-198">If the request type is TERMINATE, the Decision shape executes the terminate branch.</span></span> <span data-ttu-id="4fea7-199">Dans le cas contraire, l'orchestration teste le nouveau message pour voir s'il s'agit d'une mise à jour.</span><span class="sxs-lookup"><span data-stu-id="4fea7-199">Otherwise, the orchestration tests the new message to see if it is an update.</span></span> <span data-ttu-id="4fea7-200">Un message de mise à jour a un numéro de séquence supérieur (**SeqNum**) à la demande d’origine.</span><span class="sxs-lookup"><span data-stu-id="4fea7-200">An update message has a higher sequence number (**SeqNum**) than the original request.</span></span> <span data-ttu-id="4fea7-201">Si le numéro de séquence du nouveau message est supérieur, l'orchestration commence le traitement de la commande par ce nouveau message.</span><span class="sxs-lookup"><span data-stu-id="4fea7-201">If the new message's sequence number is higher, the orchestration starts the order processing over with the new message.</span></span> <span data-ttu-id="4fea7-202">Si le message d'origine et de mise à jour ont le même numéro de séquence ou un numéro inférieur, il s'agit d'une erreur de séquence.</span><span class="sxs-lookup"><span data-stu-id="4fea7-202">If the original and update message have the same or a lower sequence number, there is a sequence error.</span></span> <span data-ttu-id="4fea7-203">Si les numéros de séquence sont égaux, la commande est en double et indiquée comme une erreur de doublon.</span><span class="sxs-lookup"><span data-stu-id="4fea7-203">If the sequence numbers are equal, it is a duplicate order and flagged as a duplicate error.</span></span>  
  
 <span data-ttu-id="4fea7-204">Pour plus d’informations sur **SeqNum**, consultez [les champs et les Messages de clé](../core/key-messages-and-fields.md).</span><span class="sxs-lookup"><span data-stu-id="4fea7-204">For more information about **SeqNum**, see [Key Messages and Fields](../core/key-messages-and-fields.md).</span></span>  
  
## <a name="final-steps"></a><span data-ttu-id="4fea7-205">Dernières étapes</span><span class="sxs-lookup"><span data-stu-id="4fea7-205">Final Steps</span></span>  
 <span data-ttu-id="4fea7-206">Après avoir quitté les boucles, le Gestionnaire de commandes affecte l’adresse de réponse au port dynamique **CSRCompletionPort**.</span><span class="sxs-lookup"><span data-stu-id="4fea7-206">After exiting the loops, the order manager assigns the reply address to the dynamic port **CSRCompletionPort**.</span></span> <span data-ttu-id="4fea7-207">Le gestionnaire crée alors le message d'état d'achèvement, l'envoie et teste pour détecter une erreur.</span><span class="sxs-lookup"><span data-stu-id="4fea7-207">The manager then constructs the completion status message, sends it, and then tests if there was an error.</span></span> <span data-ttu-id="4fea7-208">Si une erreur s'est produite, l'orchestration exécute une forme Terminer, sinon elle prend simplement fin.</span><span class="sxs-lookup"><span data-stu-id="4fea7-208">If there was an error, the orchestration exectues a Terminate shape; otherwise, it simply ends.</span></span>  
  
## <a name="coordinating-with-the-stages"></a><span data-ttu-id="4fea7-209">Coordination avec les étapes</span><span class="sxs-lookup"><span data-stu-id="4fea7-209">Coordinating with the Stages</span></span>  
 <span data-ttu-id="4fea7-210">Les deux le **OrderBroker** d’orchestration et la seconde orchestration d’étape de traitement (**CableOrder2**) créent des entrées dans la base de données de l’historique.</span><span class="sxs-lookup"><span data-stu-id="4fea7-210">Both the **OrderBroker** orchestration and the second processing stage orchestration (**CableOrder2**) make entries in the history database.</span></span> <span data-ttu-id="4fea7-211">L’orchestration CableOrder2 met à jour les informations de l’historique des entrées par le **OrderBroker** orchestration.</span><span class="sxs-lookup"><span data-stu-id="4fea7-211">The CableOrder2 orchestration updates the history information entered by the **OrderBroker** orchestration.</span></span> <span data-ttu-id="4fea7-212">Vérifiez qu’il existe une entrée dans la base de données pour mettre à jour, afin du **OrderBroker** utilise l’accusé de réception sur le port utilisé pour la base de données.</span><span class="sxs-lookup"><span data-stu-id="4fea7-212">In order to ensure there is an entry in the database to update, the **OrderBroker** uses delivery notification on the port it uses for the database.</span></span>  
  
 <span data-ttu-id="4fea7-213">Mappages de configuration de la **OrderBroker** port pour la base de données de l’historique d’envoi à un groupe de ports d’envoi contenant deux ports : un port pour la configuration de test (**HistoryInsert-Test-SP**), un pour la mise à jour configuration (**HistoryInsert-SP**).</span><span class="sxs-lookup"><span data-stu-id="4fea7-213">Configuration maps the **OrderBroker** send port for the history database to a send port group containing two ports—one port for the test configuration (**HistoryInsert-Test-SP**), one for the regular configuration (**HistoryInsert-SP**).</span></span> <span data-ttu-id="4fea7-214">Si vous laissez les deux ports actifs dans le groupe, la solution envoie des messages aux deux ports.</span><span class="sxs-lookup"><span data-stu-id="4fea7-214">If you leave both ports in the group active, the solution sends messages on both ports.</span></span> <span data-ttu-id="4fea7-215">Ainsi, elle demande deux accusés de réception mais n'en traite qu'un.</span><span class="sxs-lookup"><span data-stu-id="4fea7-215">It thus requests two delivery notifications but processes only one.</span></span>  
  
 <span data-ttu-id="4fea7-216">Pour éviter cette situation, désinscrivez le port de test (**HistoryInsert-Test-SP**), ou arrêtez la version de test de l’application.</span><span class="sxs-lookup"><span data-stu-id="4fea7-216">To avoid this situation, unenlist the test port (**HistoryInsert-Test-SP**), or stop the test version of the application.</span></span> <span data-ttu-id="4fea7-217">Pour plus d’informations sur l’accusé de réception, consultez [accusés de réception à l’aide de](../core/using-acknowledgments.md).</span><span class="sxs-lookup"><span data-stu-id="4fea7-217">For more information about delivery notification, see [Using Acknowledgments](../core/using-acknowledgments.md).</span></span>  
  
## <a name="errors-and-routing-repaired-messagesdesign-choices"></a><span data-ttu-id="4fea7-218">Erreurs et routage de messages réparés : choix de conception</span><span class="sxs-lookup"><span data-stu-id="4fea7-218">Errors and Routing Repaired Messages—Design Choices</span></span>  
 <span data-ttu-id="4fea7-219">L’orchestration de gestionnaire d’exception et les orchestrations utilisées par les étapes de traitement de la commande utilisent une erreur de gestion d’orchestration (**ErrorHandlerOrch**) pour router les commandes incorrectes pour la réparation.</span><span class="sxs-lookup"><span data-stu-id="4fea7-219">The exception handler orchestration and orchestrations used by the order processing stages use an error handling orchestration (**ErrorHandlerOrch**) to route bad orders for repair.</span></span> <span data-ttu-id="4fea7-220">La conception suppose qu'il existe un service ou un groupe qui répare la commande dans la forme souhaitée.</span><span class="sxs-lookup"><span data-stu-id="4fea7-220">The design supposes that there is a department or group that will fix the order in the form needed.</span></span> <span data-ttu-id="4fea7-221">La commande réparée n’est pas renvoyée par l’orchestration orderbroker (**OrderBroker**).</span><span class="sxs-lookup"><span data-stu-id="4fea7-221">The repaired order is not resubmitted through the order broker orchestration (**OrderBroker**).</span></span> <span data-ttu-id="4fea7-222">Au lieu de cela, la commande normalisée est réparée dans sa forme normalisée.</span><span class="sxs-lookup"><span data-stu-id="4fea7-222">Rather, the normalized order is repaired in its normalized form.</span></span> <span data-ttu-id="4fea7-223">Dans la conception actuelle de la solution, l'orchestration du gestionnaire route le message d'erreur vers la source de la commande d'origine.</span><span class="sxs-lookup"><span data-stu-id="4fea7-223">The current design of the solution has the handler orchestration route the error message back to the source of the original order.</span></span> <span data-ttu-id="4fea7-224">Les commandes réparées, cependant, doivent être routées vers un port MSMQ sur l'orchestration du gestionnaire des erreurs.</span><span class="sxs-lookup"><span data-stu-id="4fea7-224">Repaired orders, however, have to be routed to an MSMQ port on the error handler orchestration.</span></span> <span data-ttu-id="4fea7-225">(La version de test de la solution utilise un dossier de fichiers.) Le gestionnaire d'erreurs renvoie ensuite le message réparé à l'orchestration d'appel.</span><span class="sxs-lookup"><span data-stu-id="4fea7-225">(The test version of the solution uses a file folder.) The error handler then returns the repaired message to the calling orchestration.</span></span>  
  
 <span data-ttu-id="4fea7-226">Cette solution utilise cette conception car le courtier de commandes effectue une validation et une normalisation importantes du message de commande.</span><span class="sxs-lookup"><span data-stu-id="4fea7-226">This solution uses this design, because the order broker does significant validation and normalization of the order message.</span></span> <span data-ttu-id="4fea7-227">À son tour, le message de commande nécessitant une réparation est également dans la forme normalisée.</span><span class="sxs-lookup"><span data-stu-id="4fea7-227">In turn, the order message requiring repair is also in the normalized form.</span></span> <span data-ttu-id="4fea7-228">La maintenance de la forme normalisée du message évite de devoir contourner la différence entre les formes envoyée et normalisée des messages.</span><span class="sxs-lookup"><span data-stu-id="4fea7-228">Maintaining the normalized form of the message prevents having to work around the difference between the submitted and normalized forms of the messages.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="4fea7-229">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="4fea7-229">See Also</span></span>  
 <span data-ttu-id="4fea7-230">[Logique du Gestionnaire de processus](../core/process-manager-logic.md) </span><span class="sxs-lookup"><span data-stu-id="4fea7-230">[Process Manager Logic](../core/process-manager-logic.md) </span></span>  
 [<span data-ttu-id="4fea7-231">Champs et les Messages de clé</span><span class="sxs-lookup"><span data-stu-id="4fea7-231">Key Messages and Fields</span></span>](../core/key-messages-and-fields.md)