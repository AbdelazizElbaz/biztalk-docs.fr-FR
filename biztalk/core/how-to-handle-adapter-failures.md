---
title: "Comment gérer les défaillances d’adaptateur | Documents Microsoft"
ms.custom: 
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: 
ms.suite: 
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: bdceb364-38d6-4aab-a176-bf751da1be25
caps.latest.revision: "12"
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 94ce45dbf8fcc46c952ddd5ccf7ed45e633641a4
ms.sourcegitcommit: cb908c540d8f1a692d01dc8f313e16cb4b4e696d
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 09/20/2017
---
# <a name="how-to-handle-adapter-failures"></a><span data-ttu-id="a4c11-102">Gestion des échecs de l'adaptateur</span><span class="sxs-lookup"><span data-stu-id="a4c11-102">How to Handle Adapter Failures</span></span>
<span data-ttu-id="a4c11-103">Les adaptateurs doivent en principe suspendre les messages qu'ils ne peuvent pas traiter.</span><span class="sxs-lookup"><span data-stu-id="a4c11-103">In general, adapters should suspend messages that they cannot process.</span></span> <span data-ttu-id="a4c11-104">Par exemple, un adaptateur de réception qui rencontre un échec d'envoi doit en principe suspendre les messages, bien que cette décision dépende de l'objectif de l'adaptateur.</span><span class="sxs-lookup"><span data-stu-id="a4c11-104">For example, a receive adapter that experiences a submit failure should typically suspend the messages, although this decision depends upon the purpose of the adapter.</span></span> <span data-ttu-id="a4c11-105">Il faut également prendre en considération la sécurité en ce qui concerne la gestion des échecs.</span><span class="sxs-lookup"><span data-stu-id="a4c11-105">There are also security considerations around handling failures.</span></span> <span data-ttu-id="a4c11-106">Par exemple, si un adaptateur suspend automatiquement tous les messages ayant échoué, il est peut être ouvert sur une attaque par déni de service, ce qui entraîne le remplissage de la file d'attente des messages suspendus BizTalk Server.</span><span class="sxs-lookup"><span data-stu-id="a4c11-106">For example, if an adapter automatically suspends all failed messages, the adapter might be open to a denial-of-service attack that causes the BizTalk Server Suspended queue to fill up.</span></span>  <span data-ttu-id="a4c11-107">Certains adaptateurs, comme HTTP, peuvent renvoyer un code d'erreur au client, lui indiquant que la requête a été rejetée.</span><span class="sxs-lookup"><span data-stu-id="a4c11-107">Some adapters, such as HTTP, can return a failure code to the client indicating that the request has been rejected.</span></span> <span data-ttu-id="a4c11-108">Ce type d'adaptateur renvoie souvent un code d'erreur plutôt que de suspendre le message.</span><span class="sxs-lookup"><span data-stu-id="a4c11-108">For these types of adapters it often makes sense to return a failure code rather than suspend the message.</span></span> <span data-ttu-id="a4c11-109">En principe, les adaptateurs d'envoi ne suspendent les messages qu'une fois toutes les tentatives effectuées pour les transports principal et secondaire.</span><span class="sxs-lookup"><span data-stu-id="a4c11-109">Typically send adapters only suspend messages after all of the retries have been exhausted for both primary and secondary transports.</span></span>  
  
## <a name="associate-error-processing-with-an-individual-operation-and-not-with-the-batch-that-contains-the-operation"></a><span data-ttu-id="a4c11-110">Association du traitement de l'erreur à une opération individuelle, et non au lot contenant l'opération</span><span class="sxs-lookup"><span data-stu-id="a4c11-110">Associate Error Processing with an Individual Operation and Not with the Batch That Contains the Operation</span></span>  
 <span data-ttu-id="a4c11-111">Le traitement par lot des messages dans l'adaptateur doit être invisible pour l'utilisateur.</span><span class="sxs-lookup"><span data-stu-id="a4c11-111">The batching of messages within an adapter should be invisible to the user of the adapter.</span></span> <span data-ttu-id="a4c11-112">Cela signifie que l'échec d'une opération dans un lot ne doit en aucun cas affecter d'autres opérations.</span><span class="sxs-lookup"><span data-stu-id="a4c11-112">This means that the failure of one operation in a batch should not affect any other operation in any way.</span></span> <span data-ttu-id="a4c11-113">Toutefois, les lots sont atomiques, l'échec d'un message se traduit donc par une erreur pour le lot, et aucune opération n'est traitée.</span><span class="sxs-lookup"><span data-stu-id="a4c11-113">However, batches are atomic, so the failure of one message results in an error for the batch, and no operations are processed.</span></span>  
  
 <span data-ttu-id="a4c11-114">Vous écrivez le code chargé de la gestion de l'erreur, qui renvoie les messages sans erreur et suspend les messages ayant échoué.</span><span class="sxs-lookup"><span data-stu-id="a4c11-114">You write the code that is responsible for handling the error, resubmitting the successful messages, and suspending the unsuccessful ones.</span></span> <span data-ttu-id="a4c11-115">Heureusement, BizTalk Server propose une structure des erreurs détaillée qui permet à l'adaptateur de déterminer l'opération qui a échoué.</span><span class="sxs-lookup"><span data-stu-id="a4c11-115">Fortunately, BizTalk Server provides a detailed error structure that enables your adapter to determine the specific operation that failed.</span></span> <span data-ttu-id="a4c11-116">Il permet de créer d'autres lots dans lesquels les opérations ayant réussi sont envoyées à nouveau et les opérations ayant échoué sont suspendues.</span><span class="sxs-lookup"><span data-stu-id="a4c11-116">It permits construction of further batches in which the successful operations are resubmitted and the unsuccessful ones suspended.</span></span>  
  
 <span data-ttu-id="a4c11-117">L'étape finale de l'opération ne doit pas être affectée par le traitement par lot au sein de l'adaptateur.</span><span class="sxs-lookup"><span data-stu-id="a4c11-117">The final state of the operation should not be affected by the batching within the adapter.</span></span>  
  
## <a name="use-seterrorinfo-to-report-failure-to-biztalk-server"></a><span data-ttu-id="a4c11-118">Utilisation de SetErrorInfo pour le rapport de l'échec à BizTalk Server</span><span class="sxs-lookup"><span data-stu-id="a4c11-118">Use SetErrorInfo to Report Failure to BizTalk Server</span></span>  
 <span data-ttu-id="a4c11-119">Si vous suspendez un message, vous devez fournir à BizTalk Server des informations sur l'échec à partir du contexte de message précédent.</span><span class="sxs-lookup"><span data-stu-id="a4c11-119">If you are suspending a message, you must provide failure information to BizTalk Server from the previous message context.</span></span> <span data-ttu-id="a4c11-120">BizTalk Server fournit des fonctionnalités à l’aide de rapports d’erreurs le **SetErrorInfo** méthode sur les deux le **IBaseMessage** et **ITransportProxy** interfaces.</span><span class="sxs-lookup"><span data-stu-id="a4c11-120">BizTalk Server provides error reporting capabilities using the **SetErrorInfo** method on both the **IBaseMessage** and **ITransportProxy** interfaces.</span></span> <span data-ttu-id="a4c11-121">Vous pouvez signaler les erreurs comme suit :</span><span class="sxs-lookup"><span data-stu-id="a4c11-121">You can report errors as follows:</span></span>  
  
-   <span data-ttu-id="a4c11-122">Lorsqu’une défaillance se produit lors du traitement d’un message, définissez l’exception à l’aide de **SetErrorInfo (Exception e)** sur le message (**IBaseMessage**) doit être suspendu.</span><span class="sxs-lookup"><span data-stu-id="a4c11-122">When a failure occurs while processing a message, set the exception using **SetErrorInfo(Exception e)** on the message (**IBaseMessage**) to be suspended.</span></span> <span data-ttu-id="a4c11-123">Le moteur conserve ainsi l'erreur et le message pour un diagnostic ultérieur, et la consigne dans le journal des événements pour notification à l'administrateur.</span><span class="sxs-lookup"><span data-stu-id="a4c11-123">This allows the engine to preserve the error with the message for later diagnosis and logs it to the event log to alert the administrator.</span></span>  
  
-   <span data-ttu-id="a4c11-124">Si vous rencontrez une erreur pendant l’initialisation ou de comptabilité interne (et non pendant le traitement des messages), vous devez appeler **SetErrorInfo (Exception e)** sur la **ITransportProxy** pointeur qui a été passé à Pour vous lors de l’initialisation.</span><span class="sxs-lookup"><span data-stu-id="a4c11-124">If you encounter an error during initialization or internal bookkeeping (not during message processing) you should call **SetErrorInfo(Exception e)** on the **ITransportProxy** pointer that was passed to you during initialization.</span></span> <span data-ttu-id="a4c11-125">Si l'adaptateur est basé sur une implémentation BaseAdapter, vous devez toujours avoir accès à ce pointeur.</span><span class="sxs-lookup"><span data-stu-id="a4c11-125">If your adapter is based on the BaseAdapter implementation, you should always have access to this pointer.</span></span> <span data-ttu-id="a4c11-126">Sinon, vous devez être certain de le mettre en cache.</span><span class="sxs-lookup"><span data-stu-id="a4c11-126">Otherwise, you should be certain that you cache it.</span></span>  
  
 <span data-ttu-id="a4c11-127">L'utilisation de l'une de ces méthodes entraîne l'écriture du message d'erreur dans le journal des événements.</span><span class="sxs-lookup"><span data-stu-id="a4c11-127">Reporting an error with either of these methods results in the error message being written to the event log.</span></span> <span data-ttu-id="a4c11-128">Il est important d'associer l'erreur au message correspondant si possible.</span><span class="sxs-lookup"><span data-stu-id="a4c11-128">It is important that you associate the error with the related message if you are able to do so.</span></span>  
  
## <a name="handle-a-database-offline-condition"></a><span data-ttu-id="a4c11-129">Gestion d'une condition de base de données hors connexion</span><span class="sxs-lookup"><span data-stu-id="a4c11-129">Handle a Database-Offline Condition</span></span>  
 <span data-ttu-id="a4c11-130">Si l'une des bases de données BizTalk Server est déconnectée, le service BizTalk se recycle.</span><span class="sxs-lookup"><span data-stu-id="a4c11-130">If one of the BizTalk Server databases goes offline, the BizTalk service recycles itself.</span></span> <span data-ttu-id="a4c11-131">Le moteur de messagerie tente de fermer tous les emplacements de réception avant de recycler le service.</span><span class="sxs-lookup"><span data-stu-id="a4c11-131">The Messaging Engine makes a best effort to shut down all of the receive locations before recycling the service.</span></span> <span data-ttu-id="a4c11-132">Si cela prend plus de 60 secondes, le service est arrêté.</span><span class="sxs-lookup"><span data-stu-id="a4c11-132">If this takes longer than 60 seconds, the service terminates.</span></span> <span data-ttu-id="a4c11-133">Étant donné que le moteur est traité par la transaction, il n'entraîne aucune perte de données.</span><span class="sxs-lookup"><span data-stu-id="a4c11-133">Because the engine is transacted, this does not cause data loss.</span></span>  
  
 <span data-ttu-id="a4c11-134">Ce délai peut être réglé dans le Registre à l'aide de la clé suivante :</span><span class="sxs-lookup"><span data-stu-id="a4c11-134">This time-out can be tuned in the registry by using the key:</span></span>  
  
```  
DWORD   
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\BTSSvc{Host Guid}\MessagingDBFailoverShutdownTimeLimit  
```  
  
 <span data-ttu-id="a4c11-135">Pour les adaptateurs isolés, étant donné que BizTalk Server ne possède pas le processus, les emplacements de réception sont désactivés lorsque l'une des bases de données BizTalk Server est hors connexion.</span><span class="sxs-lookup"><span data-stu-id="a4c11-135">For isolated adapters, because BizTalk Server does not own the process, the receive locations are disabled when one of the BizTalk Server databases goes offline.</span></span> <span data-ttu-id="a4c11-136">Une fois la base de données à nouveau connectée, les emplacements de réception sont de nouveau activés.</span><span class="sxs-lookup"><span data-stu-id="a4c11-136">After the database comes back online those receive locations are re-enabled.</span></span>  
  
## <a name="write-to-the-event-log"></a><span data-ttu-id="a4c11-137">Écriture dans le journal des événements</span><span class="sxs-lookup"><span data-stu-id="a4c11-137">Write to the Event Log</span></span>  
 <span data-ttu-id="a4c11-138">L’adaptateur peut écrire des entrées de journal des événements à l’aide de la **IBTTransportProxy** interface en passant une exception.</span><span class="sxs-lookup"><span data-stu-id="a4c11-138">The adapter can write event log entries by using the **IBTTransportProxy** interface passing in an exception.</span></span> <span data-ttu-id="a4c11-139">Adaptateurs développés en code natif doivent passer dans un **IErrorInfo** interface, **IBTTransportProxy.SetErrorInfo (Exception** `e` **)**.</span><span class="sxs-lookup"><span data-stu-id="a4c11-139">Adapters developed in native code need to pass in an **IErrorInfo** interface, **IBTTransportProxy.SetErrorInfo( Exception** `e` **)**.</span></span>  
  
 <span data-ttu-id="a4c11-140">Le moteur de messagerie écrit dans le journal des événements sur demande de l'adaptateur, pour des événements, comme une nouvelle tentative de l'adaptateur après un échec de transmission d'un message, l'envoi d'un message au transport secondaire ou la suspension du message.</span><span class="sxs-lookup"><span data-stu-id="a4c11-140">The Messaging Engine writes to the event log on behalf of the adapter for events such as when an adapter retries a message after transmission failure, moves a message to its backup transport, or suspends a message.</span></span> <span data-ttu-id="a4c11-141">Pour de telles opérations, l'adaptateur doit simplement définir l'exception sur le message avant d'appeler l'API.</span><span class="sxs-lookup"><span data-stu-id="a4c11-141">For operations such as these the adapter only needs to set the exception on the message before calling the API.</span></span> <span data-ttu-id="a4c11-142">Le fragment de code suivant illustre ceci :</span><span class="sxs-lookup"><span data-stu-id="a4c11-142">The following code fragment demonstrates this:</span></span>  
  
```  
IBaseMessage msg;  
...  
// Set exception on msg to indicate why transmission failed...  
msg.SetErrorInfo(  
 new ApplicationException(  
 "The TCP connection was closed by the destination"));  
```  
  
## <a name="handle-receive-specific-batch-errors"></a><span data-ttu-id="a4c11-143">Gestion des échecs de réception spécifiques au lot</span><span class="sxs-lookup"><span data-stu-id="a4c11-143">Handle Receive-Specific Batch Errors</span></span>  
  
### <a name="handle-receive-failures"></a><span data-ttu-id="a4c11-144">Gestion des échecs de réception</span><span class="sxs-lookup"><span data-stu-id="a4c11-144">Handle Receive Failures</span></span>  
 <span data-ttu-id="a4c11-145">Lorsque l'adaptateur envoie une opération (ou un lot d'opérations) au serveur BizTalk Server, les motifs d'échecs peuvent être divers.</span><span class="sxs-lookup"><span data-stu-id="a4c11-145">When an adapter submits an operation (or batch of operations) to BizTalk Server there can be various reasons for failure.</span></span> <span data-ttu-id="a4c11-146">Les deux échecs les plus significatifs sont les suivants :</span><span class="sxs-lookup"><span data-stu-id="a4c11-146">The two most significant are:</span></span>  
  
-   <span data-ttu-id="a4c11-147">Le pipeline de réception a échoué.</span><span class="sxs-lookup"><span data-stu-id="a4c11-147">The receive pipeline failed.</span></span>  
  
-   <span data-ttu-id="a4c11-148">Un échec de routage s'est produit au cours de la publication d'un message.</span><span class="sxs-lookup"><span data-stu-id="a4c11-148">A routing failure occurred while publishing a message.</span></span>  
  
 <span data-ttu-id="a4c11-149">Le moteur de message tente automatiquement de suspendre le message lorsqu'il reçoit un échec du pipeline de réception,</span><span class="sxs-lookup"><span data-stu-id="a4c11-149">The Messaging Engine automatically tries to suspend the message when it gets a receive pipeline failure.</span></span> <span data-ttu-id="a4c11-150">mais cette opération ne réussit pas systématiquement.</span><span class="sxs-lookup"><span data-stu-id="a4c11-150">The suspend operation may not always be successful.</span></span> <span data-ttu-id="a4c11-151">Par exemple, si le moteur de message rencontre un échec de routage lors de la publication du message, il ne suspend pas le message.</span><span class="sxs-lookup"><span data-stu-id="a4c11-151">For example, if the Messaging Engine hits a routing failure while publishing a message, then the engine does not even try to suspend the message.</span></span>  
  
 <span data-ttu-id="a4c11-152">Il est toujours possible qu'un message échoue.</span><span class="sxs-lookup"><span data-stu-id="a4c11-152">It is always possible that a message will fail.</span></span> <span data-ttu-id="a4c11-153">Dans ce cas, l’adaptateur doit appeler explicitement la **MoveToSuspendQ** API et tenter de suspendre le message.</span><span class="sxs-lookup"><span data-stu-id="a4c11-153">In such a situation, the adapter should explicitly call the **MoveToSuspendQ** API and should try to suspend the message.</span></span> <span data-ttu-id="a4c11-154">Lorsqu'il tente cette suspension, l'un des cas suivants doit être confirmé :</span><span class="sxs-lookup"><span data-stu-id="a4c11-154">When an adapter tries to suspend a message, one of the following should be true:</span></span>  
  
-   <span data-ttu-id="a4c11-155">L'objet de message identique à celui envoyé par l'adaptateur (recommandé) doit être suspendu.</span><span class="sxs-lookup"><span data-stu-id="a4c11-155">The same message object that the adapter submitted (recommended) should be suspended.</span></span>  
  
-   <span data-ttu-id="a4c11-156">Si l'adaptateur doit créer un message, il doit définir le contexte du nouveau message avec le pointeur orienté sur le contexte du message initial,</span><span class="sxs-lookup"><span data-stu-id="a4c11-156">If the adapter has to create a new message, then it should set the message context of the new message with the pointer to the message context of the message that was originally submitted.</span></span> <span data-ttu-id="a4c11-157">car le contexte du message comporte de nombreuses informations précieuses concernant le message et l'échec.</span><span class="sxs-lookup"><span data-stu-id="a4c11-157">This is because the message context of a message has a lot of valuable information about the message and the failure.</span></span> <span data-ttu-id="a4c11-158">Ces informations sont nécessaires au débogage du message ayant échoué.</span><span class="sxs-lookup"><span data-stu-id="a4c11-158">This information is required to debug the failed message.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="a4c11-159">Si l'adaptateur crée un objet de message et le suspend, il doit copier les informations concernant l'erreur à partir de l'objet de message initial dans le nouvel objet.</span><span class="sxs-lookup"><span data-stu-id="a4c11-159">If the adapter creates a new message object and suspends it, the adapter should copy the error information from the old message object to the new message object.</span></span>  
  
 <span data-ttu-id="a4c11-160">Certains adaptateurs, comme l'adaptateur HTTP fourni avec BizTalk Server, n'exigent pas la suspension du message.</span><span class="sxs-lookup"><span data-stu-id="a4c11-160">Some adapters, such as the HTTP adapter provided with BizTalk Server, do not require that the message be suspended.</span></span> <span data-ttu-id="a4c11-161">Ils renvoient une erreur à leur client.</span><span class="sxs-lookup"><span data-stu-id="a4c11-161">These adapters can return an error back to their client.</span></span>  
  
#### <a name="causes-of-failure"></a><span data-ttu-id="a4c11-162">Causes de l'échec</span><span class="sxs-lookup"><span data-stu-id="a4c11-162">Causes of failure</span></span>  
 <span data-ttu-id="a4c11-163">Causes simples d’échec sont les erreurs qui peuvent se produire lorsque le lot est construit ou **IBTTransportBatch::Done** est appelée.</span><span class="sxs-lookup"><span data-stu-id="a4c11-163">Simple causes of failure are the errors that can occur as the batch is constructed or when **IBTTransportBatch::Done** is called.</span></span>  
  
-   <span data-ttu-id="a4c11-164">**Échec de l’envoi.**</span><span class="sxs-lookup"><span data-stu-id="a4c11-164">**Submit failure.**</span></span> <span data-ttu-id="a4c11-165">Le **Submit** appel peut échouer pour un nombre limité de raisons, et tous sont irrécupérables.</span><span class="sxs-lookup"><span data-stu-id="a4c11-165">The **Submit** call can fail for a limited number of reasons, and all of them are fatal.</span></span> <span data-ttu-id="a4c11-166">Les raisons sont les suivantes :</span><span class="sxs-lookup"><span data-stu-id="a4c11-166">These reasons include:</span></span>  
  
-   <span data-ttu-id="a4c11-167">Des erreurs de mémoire insuffisante se produisent dans l'espace de processus BizTalk Server.</span><span class="sxs-lookup"><span data-stu-id="a4c11-167">Out-of-memory errors occurring in the BizTalk Server process space.</span></span>  
  
-   <span data-ttu-id="a4c11-168">L'assembly du schéma a été supprimé du déploiement.</span><span class="sxs-lookup"><span data-stu-id="a4c11-168">The schema assembly has been dropped from the deployment.</span></span> <span data-ttu-id="a4c11-169">Dans ce cas, le **Submit** échoue avec une erreur peu claire.</span><span class="sxs-lookup"><span data-stu-id="a4c11-169">In this case, the **Submit** fails with a cryptic error.</span></span> <span data-ttu-id="a4c11-170">Dans l'adaptateur MQSeries, l'exception générique d'échec provenant de BizTalk Server est interceptée et un message d'erreur étendue est inscrit dans le journal des événements du système.</span><span class="sxs-lookup"><span data-stu-id="a4c11-170">In the MQSeries adapter, the generic failure exception from BizTalk Server is caught, and an extended error message is written in the system event log.</span></span> <span data-ttu-id="a4c11-171">Le message indique que l'une des causes possible de l'erreur est la suppression d'une manière ou d'une autre de l'assembly du schéma du déploiement.</span><span class="sxs-lookup"><span data-stu-id="a4c11-171">This message suggests that one of the possible causes of the error is that the schema assembly has somehow been dropped from the deployment.</span></span>  
  
     <span data-ttu-id="a4c11-172">En général, si **Submit** échoue, il est conseillé de suspendre le message à l’aide de la même transaction.</span><span class="sxs-lookup"><span data-stu-id="a4c11-172">In general, if **Submit** fails you should try to suspend the message using the same transaction.</span></span>  
  
-   <span data-ttu-id="a4c11-173">**Échec de IBTTransportBatch::Done**</span><span class="sxs-lookup"><span data-stu-id="a4c11-173">**IBTTransportBatch::Done failure.**</span></span> <span data-ttu-id="a4c11-174">Le **IBTTransportBatch::Done** appel peut échouer pour plusieurs raisons.</span><span class="sxs-lookup"><span data-stu-id="a4c11-174">The **IBTTransportBatch::Done** call can fail for one of several reasons.</span></span> <span data-ttu-id="a4c11-175">En général, vous devez toujours tenter une suspension et terminer la transaction uniquement si celle-ci échoue.</span><span class="sxs-lookup"><span data-stu-id="a4c11-175">In general, you should always attempt one suspend operation and end the transaction only if that fails.</span></span> <span data-ttu-id="a4c11-176">Un des codes d’erreur peut s’afficher à partir de l’échec de **IBTTransportBatch::Done** est que BizTalk Server tente d’arrêter.</span><span class="sxs-lookup"><span data-stu-id="a4c11-176">One of the error codes you might receive from the failure of **IBTTransportBatch::Done** is that BizTalk Server is trying to shut down.</span></span> <span data-ttu-id="a4c11-177">Dans ce cas, vous devez simplement terminer la transaction et laisser car le **Terminate** appel est probablement lieu en même temps.</span><span class="sxs-lookup"><span data-stu-id="a4c11-177">In this case, you should just end the transaction and leave it because the **Terminate** call is probably happening concurrently.</span></span> <span data-ttu-id="a4c11-178">Autres scénarios se produisent lorsque vous avez construit correctement le lot et s’est exécutée correctement **IBTTransportBatch::Done**.</span><span class="sxs-lookup"><span data-stu-id="a4c11-178">Other scenarios occur when you have successfully constructed the batch and successfully executed **IBTTransportBatch::Done**.</span></span> <span data-ttu-id="a4c11-179">Dans ces cas, les erreurs sont retournées dans **BatchComplete** et l’adaptateur doit déterminer comment procéder avec eux.</span><span class="sxs-lookup"><span data-stu-id="a4c11-179">In these cases, the errors are returned in **BatchComplete** and the adapter must determine what to do with them.</span></span> <span data-ttu-id="a4c11-180">Le reste de cette rubrique traite de ce cas.</span><span class="sxs-lookup"><span data-stu-id="a4c11-180">The rest of this section deals with this case.</span></span>  
  
#### <a name="processing-batchcomplete-errors"></a><span data-ttu-id="a4c11-181">Traitements des erreurs BatchComplete</span><span class="sxs-lookup"><span data-stu-id="a4c11-181">Processing BatchComplete errors</span></span>  
 <span data-ttu-id="a4c11-182">**BatchComplete** est un rappel fourni par l’adaptateur est appelé par BizTalk Server pour indiquer l’état d’achèvement d’une opération de traitement par lots.</span><span class="sxs-lookup"><span data-stu-id="a4c11-182">**BatchComplete** is a callback provided by the adapter that is invoked by BizTalk Server to indicate the completion status of a batch operation.</span></span>  
  
 <span data-ttu-id="a4c11-183">Le paramètre le plus important passé à **BatchComplete** est l’état du lot `hResult`.</span><span class="sxs-lookup"><span data-stu-id="a4c11-183">The most important parameter passed to **BatchComplete** is the batch status `hResult`.</span></span> <span data-ttu-id="a4c11-184">Il indique la réussite ou l'échec du lot.</span><span class="sxs-lookup"><span data-stu-id="a4c11-184">This indicates success or failure for the batch.</span></span> <span data-ttu-id="a4c11-185">En cas d'échec du lot, cela signifie que toutes les opérations du lot ont échoué.</span><span class="sxs-lookup"><span data-stu-id="a4c11-185">If the batch failed, it means that none of the operations in the batch succeeded.</span></span> <span data-ttu-id="a4c11-186">L’adaptateur passe par la structure d’état du lot et détermine les messages ayant échoué (il s’agit en tant que *filtrage du lot*).</span><span class="sxs-lookup"><span data-stu-id="a4c11-186">The adapter goes through the batch status structure and determines which messages failed (this is known as *filtering the batch*).</span></span>  
  
#### <a name="nontransactional-batchcomplete-errors"></a><span data-ttu-id="a4c11-187">Erreurs BatchComplete non transactionnelles</span><span class="sxs-lookup"><span data-stu-id="a4c11-187">Nontransactional BatchComplete errors</span></span>  
 <span data-ttu-id="a4c11-188">Pour les adaptateurs non transactionnels, vous devez choisir la réponse si une défaillance se produit pour un **SubmitMessage**/**SubmitRequestMessage** ou **SubmitResponseMessage** opération.</span><span class="sxs-lookup"><span data-stu-id="a4c11-188">For nontransactional adapters, you must choose your response if a failure occurs for a **SubmitMessage**/**SubmitRequestMessage** or **SubmitResponseMessage** operation.</span></span> <span data-ttu-id="a4c11-189">En général, les adaptateurs suspendent le message en appelant **MoveToSuspendQ**.</span><span class="sxs-lookup"><span data-stu-id="a4c11-189">Typically adapters suspend the message by calling **MoveToSuspendQ**.</span></span>  
  
 <span data-ttu-id="a4c11-190">Les opérations suivantes sont supposées toujours passer : **DeleteMessage**, **MoveToSuspendQ**, **ResubmitMessage**.</span><span class="sxs-lookup"><span data-stu-id="a4c11-190">The following operations are always expected to pass: **DeleteMessage**, **MoveToSuspendQ**, **ResubmitMessage**.</span></span> <span data-ttu-id="a4c11-191">Si elles échouent, cela indique généralement un bogue au niveau de l'adaptateur.</span><span class="sxs-lookup"><span data-stu-id="a4c11-191">If these operations fail, it typically means that there is a bug in the adapter.</span></span> <span data-ttu-id="a4c11-192">Vous n'avez pas besoin d'écrire de code pour gérer l'échec dans ce cas.</span><span class="sxs-lookup"><span data-stu-id="a4c11-192">You do not have to write code to handle a failure in these cases.</span></span> <span data-ttu-id="a4c11-193">En revanche, si le lot échoue en raison de l'échec d'une autre opération, ces opérations doivent être réexécutées dans un nouveau lot.</span><span class="sxs-lookup"><span data-stu-id="a4c11-193">However if the batch failed because another operation failed, then these operations must be re-executed in a fresh batch.</span></span>  
  
 <span data-ttu-id="a4c11-194">Si l’adaptateur appelle **MovetoBackupTransport** qui échoue (car il n’a aucun transport secondaire), puis l’adaptateur doit appeler **MoveToSuspendQ** de suspendre le message.</span><span class="sxs-lookup"><span data-stu-id="a4c11-194">If the adapter calls **MovetoBackupTransport** and that fails (because there was no backup transport), then the adapter should call **MoveToSuspendQ** to suspend the message.</span></span>  
  
#### <a name="transactional-batchcomplete-errors"></a><span data-ttu-id="a4c11-195">Erreurs BatchComplete transactionnelles</span><span class="sxs-lookup"><span data-stu-id="a4c11-195">Transactional BatchComplete errors</span></span>  
 <span data-ttu-id="a4c11-196">Lorsque vous envoyez les lots à BizTalk Server à l'aide d'une transaction créée par l'adaptateur, vous devez suivre l'un des deux scénarios suivants :</span><span class="sxs-lookup"><span data-stu-id="a4c11-196">When you submit batches to BizTalk Server using a transaction created by the adapter, you should follow one of these two scenarios:</span></span>  
  
-   <span data-ttu-id="a4c11-197">**Utilisez des lots de message unique.**</span><span class="sxs-lookup"><span data-stu-id="a4c11-197">**Use single-message batches.**</span></span> <span data-ttu-id="a4c11-198">: envoyez un lot composé d'un seul message au serveur BizTalk Server.</span><span class="sxs-lookup"><span data-stu-id="a4c11-198">Send a single-message batch to BizTalk Server.</span></span> <span data-ttu-id="a4c11-199">Si cette opération échoue, vous devez envoyer un second lot à BizTalk Server sous la même transaction, mais vous devez déplacer le message problématique dans la file d'attente des messages interrompus au lieu de le renvoyer.</span><span class="sxs-lookup"><span data-stu-id="a4c11-199">If that single message fails, then you can legally send BizTalk Server a second batch under the same transaction, but you must move the offending message to the Suspended queue rather than resubmitting it.</span></span> <span data-ttu-id="a4c11-200">Une fois le message ayant échoué supprimé, l'envoi du nouveau lot doit être effectué correctement.</span><span class="sxs-lookup"><span data-stu-id="a4c11-200">After the failed message is removed, the submission of the second batch should succeed.</span></span> <span data-ttu-id="a4c11-201">Si tel est le cas, BizTalk Server confirme la réussite de l'envoi et vous pouvez alors valider la transaction.</span><span class="sxs-lookup"><span data-stu-id="a4c11-201">After that occurs you can commit the transaction when BizTalk Server confirms that the second batch was successful.</span></span> <span data-ttu-id="a4c11-202">Si le second lot échoue, l'adaptateur doit abandonner la transaction ou trouver un autre emplacement pour le message.</span><span class="sxs-lookup"><span data-stu-id="a4c11-202">If the second batch fails, the adapter must abort the transaction, or find somewhere else to place that message.</span></span> <span data-ttu-id="a4c11-203">Dans ce cas, les performances baissent immédiatement en raison du traitement de l'annulation de la transaction.</span><span class="sxs-lookup"><span data-stu-id="a4c11-203">In this scenario, you immediately take a significant performance hit due to transaction rollback processing.</span></span>  
  
     <span data-ttu-id="a4c11-204">Des techniques d'optimisation s'offrent à vous pour vous permettre d'améliorer les performances de l'adaptateur.</span><span class="sxs-lookup"><span data-stu-id="a4c11-204">There are some techniques that you can use to improve the performance of the adapter.</span></span> <span data-ttu-id="a4c11-205">Par exemple, l'adaptateur MQSeries ajuste son approche de manière dynamique au moment de l'exécution.</span><span class="sxs-lookup"><span data-stu-id="a4c11-205">For example, the MQSeries adapter adjusts its approach dynamically at run time.</span></span> <span data-ttu-id="a4c11-206">Il s'exécute avec des lots contenant 100 messages.</span><span class="sxs-lookup"><span data-stu-id="a4c11-206">It runs with 100-message batches.</span></span> <span data-ttu-id="a4c11-207">S'il rencontre une erreur, il doit terminer le lot, mais passe à des lots composés d'un seul message le temps de dépasser le message générant l'erreur.</span><span class="sxs-lookup"><span data-stu-id="a4c11-207">If it hits an error, it must end the batch, but it switches to single-message batches for a short time as it gets past the bad message.</span></span> <span data-ttu-id="a4c11-208">Il reprend ensuite les lots de 100 messages.</span><span class="sxs-lookup"><span data-stu-id="a4c11-208">It then reverts to 100-message batches.</span></span> <span data-ttu-id="a4c11-209">Si l'erreur se reproduit, il ralentit à nouveau.</span><span class="sxs-lookup"><span data-stu-id="a4c11-209">If it hits the error again, it slows down again.</span></span>  
  
-   <span data-ttu-id="a4c11-210">**Utilisez la suspension préemptive.**</span><span class="sxs-lookup"><span data-stu-id="a4c11-210">**Use preemptive suspension.**</span></span> <span data-ttu-id="a4c11-211">: créez un lot composé de plusieurs messages, dans lequel les messages contenant des erreurs sont suspendus de manière préemptive.</span><span class="sxs-lookup"><span data-stu-id="a4c11-211">Construct a multi-message batch in which the erroneous messages are preemptively suspended.</span></span> <span data-ttu-id="a4c11-212">Le lot contienne un mélange de **Submit** et **MoveToSuspendQ** opérations, et est le premier et unique lot sous la transaction.</span><span class="sxs-lookup"><span data-stu-id="a4c11-212">The batch contains a mix of **Submit** and **MoveToSuspendQ** operations, and is the first and only batch under the transaction.</span></span> <span data-ttu-id="a4c11-213">Ce lot doit réussir car les données contenant des erreurs ont été suspendues de manière préemptive et la transaction peut être validée (une fois la confirmation de BizTalk Server reçue).</span><span class="sxs-lookup"><span data-stu-id="a4c11-213">It should succeed because the bad data was preemptively suspended, and the transaction can be committed (after waiting to receive the confirmation from BizTalk Server).</span></span>  
  
     <span data-ttu-id="a4c11-214">Cela peut demander un examen ultérieur, mais cette technique a été utilisée dans l'adaptateur MSMQ.</span><span class="sxs-lookup"><span data-stu-id="a4c11-214">This might seem to require looking into the future, but this technique has been used in the MSMQ adapter.</span></span> <span data-ttu-id="a4c11-215">Elle dépend de l'existence d'ID fiables de messages uniques.</span><span class="sxs-lookup"><span data-stu-id="a4c11-215">It depends on having reliably unique message IDs.</span></span> <span data-ttu-id="a4c11-216">L'adaptateur crée un lot de messages.</span><span class="sxs-lookup"><span data-stu-id="a4c11-216">This adapter constructs a batch of messages.</span></span> <span data-ttu-id="a4c11-217">Si un échec se produit, il annule la transaction (et donc le lot), mais conserve l'ID du message dans une structure de données temporaire.</span><span class="sxs-lookup"><span data-stu-id="a4c11-217">If anything fails it rolls back the transaction (and therefore the batch), but remembers the message ID in a temporary data structure.</span></span> <span data-ttu-id="a4c11-218">(Pour éviter que cette structure n'augmente indéfiniment, les éléments qu'elle contient sont supprimés à l'expiration d'un délai donné.) Avant l'envoi de chaque lot, l'adaptateur vérifie la liste des ID de messages incorrects.</span><span class="sxs-lookup"><span data-stu-id="a4c11-218">(To prevent this structure from growing indefinitely, items in it are removed after some fixed time delay.) Before each batch is submitted, the adapter checks the list of bad message IDs.</span></span> <span data-ttu-id="a4c11-219">S'il en rencontre un, il détecte que le message échouera (car il a déjà échoué auparavant) et le suspend de manière préemptive au lieu de le renvoyer.</span><span class="sxs-lookup"><span data-stu-id="a4c11-219">If it sees one, it knows that message will fail (because it failed once in the past), and preemptively suspends it rather than trying to submit it.</span></span>  
  
     <span data-ttu-id="a4c11-220">Les adaptateurs n'ont pas tous d'ID fiables de messages uniques, et un magasin de transactions est encore moins susceptible d'en avoir un.</span><span class="sxs-lookup"><span data-stu-id="a4c11-220">Not every adapter has a reliably unique message ID, and a transactional store is less likely to have one.</span></span> <span data-ttu-id="a4c11-221">Ainsi, de nombreux adaptateurs transactionnels sont limités à l'envoi de lots composés d'un seul message.</span><span class="sxs-lookup"><span data-stu-id="a4c11-221">Because of this, many transactional adapters are restricted to sending single-message batches.</span></span>  
  
#### <a name="processing-other-errors"></a><span data-ttu-id="a4c11-222">Traitement des autres erreurs</span><span class="sxs-lookup"><span data-stu-id="a4c11-222">Processing other errors</span></span>  
 <span data-ttu-id="a4c11-223">Dans tous les autres cas, (comme un échec de suspension de message), l'adaptateur doit terminer la transaction.</span><span class="sxs-lookup"><span data-stu-id="a4c11-223">In all other cases (such as failures in suspending messages), the adapter must end the transaction.</span></span> <span data-ttu-id="a4c11-224">Tout autre résultat se traduira par la présence de messages dupliqués ou une suppression des messages.</span><span class="sxs-lookup"><span data-stu-id="a4c11-224">Any other outcome results in either duplicate or dropped messages.</span></span>  
  
 <span data-ttu-id="a4c11-225">Lorsque l'adaptateur en a la possibilité, il doit abandonner la transaction si un lot échoue.</span><span class="sxs-lookup"><span data-stu-id="a4c11-225">Whenever the adapter can, it should abort the transaction if a batch fails.</span></span> <span data-ttu-id="a4c11-226">Cependant, dans certains cas, il ne peut pas procéder à cet abandon.</span><span class="sxs-lookup"><span data-stu-id="a4c11-226">However there are scenarios where the adapter cannot abort the transaction.</span></span> <span data-ttu-id="a4c11-227">Il doit alors suspendre le message à l'aide de la même transaction.</span><span class="sxs-lookup"><span data-stu-id="a4c11-227">In such a scenario it should suspend the message using the same transaction.</span></span>  
  
#### <a name="processing-errors-on-transactional-receive"></a><span data-ttu-id="a4c11-228">Traitement des erreurs de réception transactionnelle</span><span class="sxs-lookup"><span data-stu-id="a4c11-228">Processing errors on transactional receive</span></span>  
 <span data-ttu-id="a4c11-229">L'arrêt de la transaction en cas d'erreur constitue le modèle de traitement transactionnel commun.</span><span class="sxs-lookup"><span data-stu-id="a4c11-229">A common transactional processing pattern is to end a transaction when an error occurs.</span></span> <span data-ttu-id="a4c11-230">Dans ce cas, chaque élément retourne à son état précédent et aucune donnée n'est perdue.</span><span class="sxs-lookup"><span data-stu-id="a4c11-230">In this case everything returns to its previous state and no data is lost.</span></span> <span data-ttu-id="a4c11-231">Toutefois, si vous utilisez des données à partir d'une source transactionnelle (par exemple, retirer une par une les lignes d'une table intermédiaire dans une base de données, ou retirer un par un les messages d'un produit de mise en file d'attente comme MQSeries ou MSMQ), cela peut s'avérer insuffisant.</span><span class="sxs-lookup"><span data-stu-id="a4c11-231">However, if you are consuming data from a transactional feed (for example, pulling a row at a time from a staging table in a database, or pulling one message at a time from a queuing product like MQSeries or MSMQ), then this might not be enough.</span></span> <span data-ttu-id="a4c11-232">Si vous terminez simplement la transaction et que vous reprenez les mêmes données, la même erreur risque de se reproduire et le système risque de se bloquer dans une boucle répétée.</span><span class="sxs-lookup"><span data-stu-id="a4c11-232">If you simply end the transaction and go back and pick up the same data again, the same error is likely to occur and the system becomes stuck in a repeated loop.</span></span>  
  
 <span data-ttu-id="a4c11-233">L'adaptateur SQL d'une version antérieure de BizTalk Server se comportait ainsi.</span><span class="sxs-lookup"><span data-stu-id="a4c11-233">The SQL adapter in an earlier version of BizTalk Server shipped with this behavior.</span></span> <span data-ttu-id="a4c11-234">Peu après la sortie du produit, le comportement de cet adaptateur a été modifié de sorte qu'il tente de suspendre un message ayant échoué et de valider la transaction.</span><span class="sxs-lookup"><span data-stu-id="a4c11-234">However, soon after release the adapter behavior was changed to attempt to suspend a failed message and commit the transaction.</span></span> <span data-ttu-id="a4c11-235">Le déplacement d'un message vers la file d'attente des messages interrompus sous la même transaction et la validation de la transaction empêche de perdre des données et permet à l'adaptateur de passer les données erronées.</span><span class="sxs-lookup"><span data-stu-id="a4c11-235">Moving a message to the Suspended queue under the same transaction and then committing the transaction saves the data from being lost and also allows the adapter to get past bad data.</span></span>  
  
 <span data-ttu-id="a4c11-236">Lorsque la partie réception d’un adaptateur reçoit un message d’erreur en réponse à une **Submit** message d’opération, l’adaptateur doit traiter l’erreur et déplacer le message vers la file d’attente de messages interrompus.</span><span class="sxs-lookup"><span data-stu-id="a4c11-236">When the receive portion of an adapter is passed an error message in response to a **Submit** message operation, the adapter should process that error and move the message to the Suspended queue.</span></span>  
  
 <span data-ttu-id="a4c11-237">Dans le cas de lots transactionnels pour lesquels l'adaptateur a créé un objet de transaction et envoie les messages sous la transaction, l'adaptateur doit logiquement déplacer le message dans la file d'attente des messages interrompus sous la même transaction si un échec se produit.</span><span class="sxs-lookup"><span data-stu-id="a4c11-237">In the case of transactional batches in which the adapter has created the transaction object and submits messages under the transaction, the adapter should logically move the message to the Suspended queue under the same transaction when failures occur.</span></span> <span data-ttu-id="a4c11-238">La transaction garantit que les données ne sont pas supprimées. Même les données qui génèrent l'erreur ne doivent jamais être supprimées.</span><span class="sxs-lookup"><span data-stu-id="a4c11-238">The transaction ensures that data is not dropped, and even data that is causing an error should never be dropped.</span></span>  
  
### <a name="handle-messages-without-subscriptions"></a><span data-ttu-id="a4c11-239">Gestion des messages sans abonnement</span><span class="sxs-lookup"><span data-stu-id="a4c11-239">Handle Messages without Subscriptions</span></span>  
 <span data-ttu-id="a4c11-240">BizTalk Server rejette la publication d'un message dans la base de données MessageBox si aucun abonnement n'est défini pour l'accepter.</span><span class="sxs-lookup"><span data-stu-id="a4c11-240">BizTalk Server does not accept a message to be published in its MessageBox database if there are no subscriptions defined to accept it.</span></span> <span data-ttu-id="a4c11-241">Les abonnements sont enregistrés soit par les orchestrations, soit par les ports d'envoi.</span><span class="sxs-lookup"><span data-stu-id="a4c11-241">Subscriptions are registered by either orchestrations or send ports.</span></span> <span data-ttu-id="a4c11-242">Il est possible de définir plusieurs abonnements, auquel cas le message est envoyé à plusieurs destinations.</span><span class="sxs-lookup"><span data-stu-id="a4c11-242">Multiple subscriptions can be defined, in which case the message is sent to multiple destinations.</span></span> <span data-ttu-id="a4c11-243">En cas d'absence d'abonnement, BizTalk Server rejette le message et ne tente pas de le suspendre.</span><span class="sxs-lookup"><span data-stu-id="a4c11-243">If there are no subscriptions, BizTalk Server rejects the message and does not attempt to suspend it.</span></span> <span data-ttu-id="a4c11-244">Si l'adaptateur ne gère pas cette erreur et ne suspend pas de manière explicite le message, ce dernier est supprimé et ses données peuvent être perdues.</span><span class="sxs-lookup"><span data-stu-id="a4c11-244">If the adapter does not handle this error and explicitly suspend the message, then the message is dropped and its data is potentially lost.</span></span> <span data-ttu-id="a4c11-245">Un adaptateur transactionnel peut évidemment terminer la transaction et renvoyer le message à sa destination.</span><span class="sxs-lookup"><span data-stu-id="a4c11-245">Of course a transactional adapter may end the transaction and return the message to its destination.</span></span>  
  
### <a name="support-seek-with-your-receive-stream"></a><span data-ttu-id="a4c11-246">Prise en charge de la méthode Seek avec le flux de réception</span><span class="sxs-lookup"><span data-stu-id="a4c11-246">Support Seek with Your Receive Stream</span></span>  
 <span data-ttu-id="a4c11-247">Le flux de réception doit prendre en charge la **recherche** procédé de BizTalk Server être en mesure de suspendre le message sur une erreur de pipeline.</span><span class="sxs-lookup"><span data-stu-id="a4c11-247">The receive-side stream must support the **Seek** method for BizTalk Server to be able to suspend the message on a pipeline failure.</span></span> <span data-ttu-id="a4c11-248">Si le flux de message n’est pas identifiable, BizTalk Server génère une erreur lorsqu’il tente d’exécuter **recherche**.</span><span class="sxs-lookup"><span data-stu-id="a4c11-248">If the message stream is not seekable, then BizTalk Server generates an error when it tries to run **Seek**.</span></span>  
  
 <span data-ttu-id="a4c11-249">Dans de nombreux cas de prise en charge **recherche** n’est pas facile.</span><span class="sxs-lookup"><span data-stu-id="a4c11-249">In many cases supporting **Seek** is not easy.</span></span> <span data-ttu-id="a4c11-250">Lors d'un flux de données à partir d'un réseau, par exemple, il peut s'avérer difficile de revenir à la ressource réseau et de redemander les données.</span><span class="sxs-lookup"><span data-stu-id="a4c11-250">When streaming data from a network, for example, it may be difficult to go back to the network resource and request the data again.</span></span>  
  
 <span data-ttu-id="a4c11-251">Plusieurs adaptateurs fournis avec BizTalk Server mettent en file d'attente les données du message dans un fichier ou sur le disque pendant que BizTalk Server les lit.</span><span class="sxs-lookup"><span data-stu-id="a4c11-251">Several adapters that ship with BizTalk Server spool the message data onto a file on disk at the same time as BizTalk Server reads the data.</span></span> <span data-ttu-id="a4c11-252">Cela permet à la carte à utiliser **recherche** sur le fichier s’il rencontre une erreur (dans le traitement du pipeline des données du message, par exemple).</span><span class="sxs-lookup"><span data-stu-id="a4c11-252">This allows the adapter to use **Seek** on that file if it encounters an error (in the pipeline processing of the message data, for example).</span></span> <span data-ttu-id="a4c11-253">En interne, l’adaptateur utilise le **ReadOnlySeekableStream** classe qui encapsule un flux non identifiable entrant et déborde sur le disque lorsqu’un seuil de taille configurable est atteint.</span><span class="sxs-lookup"><span data-stu-id="a4c11-253">Internally the adapter uses the **ReadOnlySeekableStream** class that wraps an incoming non-seekable stream and overflows to disk when a configurable size threshold is reached.</span></span> <span data-ttu-id="a4c11-254">Pour les messages de taille inférieure au seuil, le disque n'est jamais atteint.</span><span class="sxs-lookup"><span data-stu-id="a4c11-254">For messages smaller than the threshold size, the disk is never hit.</span></span>  
  
### <a name="consider-user-configurable-error-handling-options"></a><span data-ttu-id="a4c11-255">Prise en compte des options de gestion d'erreur configurables par l'utilisateur</span><span class="sxs-lookup"><span data-stu-id="a4c11-255">Consider User-Configurable Error-Handling Options</span></span>  
 <span data-ttu-id="a4c11-256">Il peut arriver parfois qu'il n'existe aucune réponse pour corriger une erreur.</span><span class="sxs-lookup"><span data-stu-id="a4c11-256">Sometimes there is no one correct response to an error.</span></span> <span data-ttu-id="a4c11-257">Dans ce cas, vous devez tenir compte de l'option configurable par l'utilisateur à choisir entre divers comportements,</span><span class="sxs-lookup"><span data-stu-id="a4c11-257">In this case, you should consider a user-configurable option to choose between behaviors.</span></span> <span data-ttu-id="a4c11-258">ce que fait l'adaptateur MQSeries.</span><span class="sxs-lookup"><span data-stu-id="a4c11-258">The MQSeries adapter does this.</span></span>  
  
 <span data-ttu-id="a4c11-259">Le problème avec un adaptateur suspend les messages lorsqu’il rencontre une erreur est que la file d’attente de messages interrompus dans BizTalk Server est un élément d’un « trou noir ».</span><span class="sxs-lookup"><span data-stu-id="a4c11-259">The problem with having the adapter suspend messages when it sees an error is that the Suspended queue in BizTalk Server is something of a "black hole."</span></span> <span data-ttu-id="a4c11-260">Il est relativement facile d’obtenir les messages dans la file d’attente, mais très difficile de les retirer à nouveau.</span><span class="sxs-lookup"><span data-stu-id="a4c11-260">It is relatively easy to get messages into the queue, but harder to get them out again.</span></span>  
  
 <span data-ttu-id="a4c11-261">Certains utilisateurs de l'adaptateur préfèrent que la file d'attente des messages interrompus soit vide.</span><span class="sxs-lookup"><span data-stu-id="a4c11-261">Some users of the adapter might not want anything in the Suspended queue.</span></span> <span data-ttu-id="a4c11-262">Dans le cas de l'adaptateur MQSeries par exemple, l'utilisateur dispose d'une option de configuration afin d'effectuer l'une des opérations suivantes :</span><span class="sxs-lookup"><span data-stu-id="a4c11-262">For example, in the case of the MQSeries adapter, the user is offered a configuration option to do one of the following:</span></span>  
  
-   <span data-ttu-id="a4c11-263">définir l'adaptateur pour qu'il termine la transaction en cours et se désactive lorsqu'il rencontre une erreur ;</span><span class="sxs-lookup"><span data-stu-id="a4c11-263">Set the adapter to end the current transaction and disable itself when it sees an error.</span></span>  
  
-   <span data-ttu-id="a4c11-264">suspendre le message ayant échoué et valider la transaction.</span><span class="sxs-lookup"><span data-stu-id="a4c11-264">Suspend the failed message and commit the transaction.</span></span> <span data-ttu-id="a4c11-265">L'adaptateur procède ainsi même lorsque BizTalk Server a correctement suspendu le message.</span><span class="sxs-lookup"><span data-stu-id="a4c11-265">The adapter does this even when BizTalk Server has successfully suspended the message.</span></span> <span data-ttu-id="a4c11-266">Cette action répond aux besoins du client même si le journal des événements n'est alors pas strictement correct.</span><span class="sxs-lookup"><span data-stu-id="a4c11-266">This action meets the requirements of the customer even if it causes the event log to not be strictly correct.</span></span>  
  
### <a name="implement-receive-ordering-by-using-a-single-thread-and-waiting-on-batchcomplete"></a><span data-ttu-id="a4c11-267">Implémentation du classement de réception à l'aide d'un seul thread et attente de BatchComplete</span><span class="sxs-lookup"><span data-stu-id="a4c11-267">Implement Receive Ordering by Using a Single Thread and Waiting on BatchComplete</span></span>  
 <span data-ttu-id="a4c11-268">L'interface de BizTalk Server est conçue pour des performances optimales et pour pouvoir évoluer grâce à la prise en charge de l'accès concurrentiel.</span><span class="sxs-lookup"><span data-stu-id="a4c11-268">The interface to BizTalk Server is designed for performance and the ability to scale out by supporting concurrency.</span></span> <span data-ttu-id="a4c11-269">Toutefois, si vous souhaitez classer de manière stricte la réception des messages (comme cela est parfois requis lors de la réception de messages provenant d'un produit de mise en file d'attente de messages tel que MQSeries ou MSMQ), vous devez effectuer des opérations supplémentaires dans l'adaptateur pour désactiver en partie l'accès concurrentiel.</span><span class="sxs-lookup"><span data-stu-id="a4c11-269">However, if you want a strictly ordered receive of messages (as is sometimes required when receiving messages from a message queue product like MQSeries or MSMQ), then you must do some additional work in the adapter to disable some of that concurrency.</span></span> <span data-ttu-id="a4c11-270">Cette opération peut être effectuée en deux étapes :</span><span class="sxs-lookup"><span data-stu-id="a4c11-270">This can be done in two steps:</span></span>  
  
1.  <span data-ttu-id="a4c11-271">Vous devez utiliser un seul thread pour tout traitement de données dans l'adaptateur.</span><span class="sxs-lookup"><span data-stu-id="a4c11-271">You must use a single thread for all the data processing in the adapter.</span></span>  
  
2.  <span data-ttu-id="a4c11-272">Vous devez attendre que BizTalk Server ait complètement traité chaque lot.</span><span class="sxs-lookup"><span data-stu-id="a4c11-272">You must wait for BizTalk Server to completely process each batch.</span></span> <span data-ttu-id="a4c11-273">Ce point est important et vous pouvez l'effectuer à l'aide des primitives de synchronisation de threads .NET.</span><span class="sxs-lookup"><span data-stu-id="a4c11-273">This requirement is important and can be accomplished by using .NET thread synchronization primitives.</span></span> <span data-ttu-id="a4c11-274">Par exemple, en utilisant un **AutoResetEvent**, vous devez :</span><span class="sxs-lookup"><span data-stu-id="a4c11-274">For example, using an **AutoResetEvent**, you would:</span></span>  
  
    -   <span data-ttu-id="a4c11-275">Déclarez l’objet d’événement où il est accessible par les deux le thread de travail principal et le **BatchComplete** objet de rappel.</span><span class="sxs-lookup"><span data-stu-id="a4c11-275">Declare the event object where it can be accessed by both the main worker thread and the **BatchComplete** callback object.</span></span>  
  
    -   <span data-ttu-id="a4c11-276">Sur le thread de travail principal, envoyer des messages au lot comme d’habitude, puis appeler **AutoResetEvent.Reset** sur l’objet d’événement juste avant l’appel au lot **IBTTransportBatch::Done**.</span><span class="sxs-lookup"><span data-stu-id="a4c11-276">On the main worker thread, submit the messages to the batch as usual but then call **AutoResetEvent.Reset** on the event object just before the call to the batch **IBTTransportBatch::Done**.</span></span>  
  
    -   <span data-ttu-id="a4c11-277">Appelez **AutoResetEvent.WaitOne** sur l’objet d’événement à partir de ce même thread.</span><span class="sxs-lookup"><span data-stu-id="a4c11-277">Call **AutoResetEvent.WaitOne** on the event object from this same thread.</span></span> <span data-ttu-id="a4c11-278">Le thread de travail principal est ainsi bloqué.</span><span class="sxs-lookup"><span data-stu-id="a4c11-278">This causees the main worker thread to block.</span></span> <span data-ttu-id="a4c11-279">Dans le **BatchComplete** rappel à partir de BizTalk Server vous appelez ensuite **AutoResetEvent.Set** sur le même objet d’événement pour débloquer le thread de travail, il est prêt à traiter un autre message.</span><span class="sxs-lookup"><span data-stu-id="a4c11-279">In the **BatchComplete** callback from BizTalk Server you then call **AutoResetEvent.Set** on the same event object to unblock the worker thread so it is ready to process another message.</span></span>  
  
 <span data-ttu-id="a4c11-280">Il est fortement recommandé que *classement de réception* comme cela sera rendu configurable, car elle force dégradation significative des performances.</span><span class="sxs-lookup"><span data-stu-id="a4c11-280">It is strongly suggested that *receive ordering* like this be made configurable because it causes significant performance degradation.</span></span> <span data-ttu-id="a4c11-281">De nombreux scénarios (et même la plupart) ne requièrent pas le classement des messages.</span><span class="sxs-lookup"><span data-stu-id="a4c11-281">Many, if not most, user scenarios do not require ordering of messages.</span></span> <span data-ttu-id="a4c11-282">La suspension des messages peut également interrompre le classement.</span><span class="sxs-lookup"><span data-stu-id="a4c11-282">Suspending messages can also break ordering.</span></span> <span data-ttu-id="a4c11-283">La marche à suivre dans ce cas dépend de l'application. Il est donc préférable que l'adaptateur propose à l'utilisateur une possibilité de configuration.</span><span class="sxs-lookup"><span data-stu-id="a4c11-283">Exactly what to do in this case is application-dependent, so the best thing for your adapter to do is to offer the user a configuration point.</span></span>  
  
 <span data-ttu-id="a4c11-284">Dans certains cas de classement, des clients ont indiqué préférer arrêter le traitement, c'est-à-dire désactiver l'adaptateur, plutôt qu'interrompre le classement.</span><span class="sxs-lookup"><span data-stu-id="a4c11-284">In ordered scenarios, some customers have stated that they would prefer to stop the processing, that is, disable the adapter, rather than break ordering.</span></span> <span data-ttu-id="a4c11-285">L'adaptateur MQSeries, qui prend en charge le classement de réception, propose cette option.</span><span class="sxs-lookup"><span data-stu-id="a4c11-285">The MQSeries adapter, which supports ordered receive, provides this option to the user.</span></span>  
  
## <a name="handle-send-specific-batch-errors"></a><span data-ttu-id="a4c11-286">Gestion des échecs d'envoi spécifiques au lot</span><span class="sxs-lookup"><span data-stu-id="a4c11-286">Handle Send-Specific Batch Errors</span></span>  
  
### <a name="handle-send-retry-and-batching"></a><span data-ttu-id="a4c11-287">Gestion des tentatives d'envoi et du traitement par lot</span><span class="sxs-lookup"><span data-stu-id="a4c11-287">Handle Send Retry and Batching</span></span>  
 <span data-ttu-id="a4c11-288">Voici un exemple type de traitement par lot d'envoi :</span><span class="sxs-lookup"><span data-stu-id="a4c11-288">Here is a typical example of send-side batching:</span></span>  
  
-   <span data-ttu-id="a4c11-289">BizTalk Server transmet un lot de messages à l'adaptateur.</span><span class="sxs-lookup"><span data-stu-id="a4c11-289">BizTalk Server gives a batch of messages to the adapter.</span></span>  
  
-   <span data-ttu-id="a4c11-290">Lorsque l'adaptateur détermine qu'il a remis le message à la destination, il exécute la suppression sur BizTalk Server, ce qui indique que la tâche est effectuée.</span><span class="sxs-lookup"><span data-stu-id="a4c11-290">When the adapter determines that it has given the message to its destination correctly, it executes delete back on BizTalk Server indicating that it is done.</span></span> <span data-ttu-id="a4c11-291">(Comme toujours, plusieurs messages peuvent être mis en lot de manière arbitraire pour améliorer les performances.)</span><span class="sxs-lookup"><span data-stu-id="a4c11-291">(As usual, several delete messages can be arbitrarily batched up to improve performance.)</span></span>  
  
 <span data-ttu-id="a4c11-292">Si l'adaptateur au niveau de l'envoi ne parvient pas à traiter un message, il a plusieurs possibilités :</span><span class="sxs-lookup"><span data-stu-id="a4c11-292">If the send-side adapter fails to process a message, then it may do one of several things with that message:</span></span>  
  
-   <span data-ttu-id="a4c11-293">Il doit indiquer à BizTalk Server que le message doit à nouveau être envoyé.</span><span class="sxs-lookup"><span data-stu-id="a4c11-293">The adapter should tell BizTalk Server that it wants a message retried.</span></span> <span data-ttu-id="a4c11-294">BizTalk Server ne renvoie pas automatiquement le message.</span><span class="sxs-lookup"><span data-stu-id="a4c11-294">BizTalk Server does not automatically retry a message.</span></span> <span data-ttu-id="a4c11-295">BizTalk Server conserve le nombre de tentatives et l'affiche dans le contexte du message.</span><span class="sxs-lookup"><span data-stu-id="a4c11-295">BizTalk Server keeps a count of the retries, and this count can be seen in the message context.</span></span>  
  
-   <span data-ttu-id="a4c11-296">Il peut déterminer qu'il lui est impossible de traiter un message.</span><span class="sxs-lookup"><span data-stu-id="a4c11-296">The adapter may determine that it cannot process a message.</span></span> <span data-ttu-id="a4c11-297">Dans ce cas, il peut déplacer le message dans le transport suivant.</span><span class="sxs-lookup"><span data-stu-id="a4c11-297">In this case, the adapter might move the message to the next transport.</span></span> <span data-ttu-id="a4c11-298">L’adaptateur procède à la **MoveToNextTransport** appeler sur le **lot** objet.</span><span class="sxs-lookup"><span data-stu-id="a4c11-298">The adapter does this with the **MoveToNextTransport** call on the **Batch** object.</span></span>  
  
-   <span data-ttu-id="a4c11-299">Il peut placer le message dans la file d'attente des messages interrompus.</span><span class="sxs-lookup"><span data-stu-id="a4c11-299">The adapter may move the message to the Suspended queue.</span></span>  
  
 <span data-ttu-id="a4c11-300">Il détermine les événements suivants pour le message.</span><span class="sxs-lookup"><span data-stu-id="a4c11-300">The adapter determines what happens to the message.</span></span> <span data-ttu-id="a4c11-301">Il est cependant préférable que les adaptateurs se comportent de manière cohérente de sorte à faciliter la prise en charge de l'installation BizTalk Server.</span><span class="sxs-lookup"><span data-stu-id="a4c11-301">However, it is recommended that you have adapters behave in a consistent manner because this makes a BizTalk Server installation easier to support.</span></span>  
  
 <span data-ttu-id="a4c11-302">Il est vivement conseillé que les adaptateurs se comportent comme décrit ci-après.</span><span class="sxs-lookup"><span data-stu-id="a4c11-302">It is highly recommended that adapters behave as described below.</span></span> <span data-ttu-id="a4c11-303">Les adaptateurs fournis avec BizTalk Server se comportent ainsi.</span><span class="sxs-lookup"><span data-stu-id="a4c11-303">The adapters shipped with BizTalk Server behave like this.</span></span>  
  
### <a name="recommended-behavior-for-handling-send-errors-in-a-batch"></a><span data-ttu-id="a4c11-304">Comportement recommandé pour la gestion des erreurs d'envoi dans un lot</span><span class="sxs-lookup"><span data-stu-id="a4c11-304">Recommended Behavior for Handling Send Errors in a Batch</span></span>  
 <span data-ttu-id="a4c11-305">L'adaptateur d'envoi reçoit des messages et les envoie à BizTalk Server.</span><span class="sxs-lookup"><span data-stu-id="a4c11-305">The send adapter receives some messages and submits them to BizTalk Server.</span></span>  
  
 <span data-ttu-id="a4c11-306">L'adaptateur supprime un message sur BizTalk Server chaque fois qu'il est traité correctement.</span><span class="sxs-lookup"><span data-stu-id="a4c11-306">For each successful message the adapter should delete that message on BizTalk Server.</span></span> <span data-ttu-id="a4c11-307">Toute communication de retour vers BizTalk Server et effectuée par lot, et les suppressions peuvent aussi être effectuées par lot.</span><span class="sxs-lookup"><span data-stu-id="a4c11-307">All communication back to BizTalk Server is done through batches, and the deletes can be batched up.</span></span> <span data-ttu-id="a4c11-308">Le lot peut être différent de celui créé par BizTalk Server sur l'adaptateur.</span><span class="sxs-lookup"><span data-stu-id="a4c11-308">They do not have to be the same batch that BizTalk Server created on the adapter.</span></span> <span data-ttu-id="a4c11-309">En cas de messages de réponse (comme pour un scénario SolicitResponse), ils doivent être renvoyés à BizTalk Server (avec SubmitResponse) avec la suppression associée.</span><span class="sxs-lookup"><span data-stu-id="a4c11-309">If there are any response messages (as in a SolicitResponse scenario), then they should be submitted back to BizTalk Server (with SubmitResponse) along with the associated delete.</span></span>  
  
-   <span data-ttu-id="a4c11-310">Si le traitement du message a échoué dans l'adaptateur, vérifiez le nombre de tentatives.</span><span class="sxs-lookup"><span data-stu-id="a4c11-310">If the message processing in the adapter was unsuccessful, check the retry count.</span></span>  
  
    -   <span data-ttu-id="a4c11-311">Si le nombre de tentatives n'a pas été dépassé, renvoyez le message à BizTalk Server, et pensez à définir le délai de tentatives sur le message.</span><span class="sxs-lookup"><span data-stu-id="a4c11-311">If the retry count was not exceeded, resubmit the message to BizTalk Server, remembering to set the retry time on the message.</span></span> <span data-ttu-id="a4c11-312">Le contexte du message fournit le nombre de tentatives et l'intervalle avant nouvelle tentative que doit utiliser l'adaptateur.</span><span class="sxs-lookup"><span data-stu-id="a4c11-312">The message context provides the retry count and the retry interval the adapter should use.</span></span>  
  
    -   <span data-ttu-id="a4c11-313">Si le nombre de tentatives a été dépassé, l’adaptateur doit tenter de déplacer le message à l’aide de **MoveToNextTransport**.</span><span class="sxs-lookup"><span data-stu-id="a4c11-313">If the retry count was exceeded, then the adapter should attempt to move the message by using **MoveToNextTransport**.</span></span> <span data-ttu-id="a4c11-314">Le nouvel envoi et **MoveToNextTransport** messages peuvent être mélangés aux suppressions dans le même lot à BizTalk Server.</span><span class="sxs-lookup"><span data-stu-id="a4c11-314">The resubmit and **MoveToNextTransport** messages can be mixed with the deletes in the same batch back to BizTalk Server.</span></span> <span data-ttu-id="a4c11-315">Cette étape n'est pas obligatoire mais peut s'avérer utile.</span><span class="sxs-lookup"><span data-stu-id="a4c11-315">This is not required, but can be a useful step.</span></span>  
  
-   <span data-ttu-id="a4c11-316">Le nouvel envoi et la **MoveToNextTransport** sont des méthodes de la carte pour traiter les échecs.</span><span class="sxs-lookup"><span data-stu-id="a4c11-316">The resubmit and the **MoveToNextTransport** are ways for the adapter to deal with failures.</span></span> <span data-ttu-id="a4c11-317">Lors du traitement d'un échec, un autre échec peut se produire.</span><span class="sxs-lookup"><span data-stu-id="a4c11-317">But there can be a failure within the processing of the failure.</span></span> <span data-ttu-id="a4c11-318">Dans ce cas, lors du traitement de la réponse à partir de BizTalk Server (dans le **BatchComplete** méthode) l’adaptateur doit créer un autre lot sur BizTalk Server pour indiquer comment traiter cet échec.</span><span class="sxs-lookup"><span data-stu-id="a4c11-318">In this case, in processing the response from BizTalk Server (in the **BatchComplete** method) the adapter must create another batch against BizTalk Server to indicate what to do with that failure.</span></span>  
  
     <span data-ttu-id="a4c11-319">Procédez comme suit pour traiter un échec qui se produit pendant le traitement d'un autre échec :</span><span class="sxs-lookup"><span data-stu-id="a4c11-319">Follow these steps when processing a failure that occurs within the processing of another failure:</span></span>  
  
    -   <span data-ttu-id="a4c11-320">Si le nouvel envoi échoue, utilisez **MoveToNextTransport**.</span><span class="sxs-lookup"><span data-stu-id="a4c11-320">If the resubmit fails, use **MoveToNextTransport**.</span></span>  
  
    -   <span data-ttu-id="a4c11-321">Si le **MoveToNextTransport** échoue, utilisez **MoveToSuspendQ**.</span><span class="sxs-lookup"><span data-stu-id="a4c11-321">If the **MoveToNextTransport** fails, use **MoveToSuspendQ**.</span></span>  
  
 <span data-ttu-id="a4c11-322">Vous devez poursuivre la création de lots sur BizTalk Server jusqu'à ce que ce dernier reçoive une action correctement effectuée.</span><span class="sxs-lookup"><span data-stu-id="a4c11-322">You must keep creating batches on BizTalk Server until you receive a successful action back on BizTalk Server.</span></span>  
  
### <a name="serialization-of-message-context-property"></a><span data-ttu-id="a4c11-323">Sérialisation d'une propriété de contexte de message</span><span class="sxs-lookup"><span data-stu-id="a4c11-323">Serialization of Message Context Property</span></span>  
 <span data-ttu-id="a4c11-324">Tous les objets affectés à une propriété de contexte de message doivent être sérialisables,</span><span class="sxs-lookup"><span data-stu-id="a4c11-324">All objects assigned to a message context property must be serializable.</span></span> <span data-ttu-id="a4c11-325">Dans le cas contraire, le moteur de messagerie lève une exception de type **E_NOINTERFACE**.</span><span class="sxs-lookup"><span data-stu-id="a4c11-325">Otherwise the Messaging Engine will throw an exception of type **E_NOINTERFACE**.</span></span> <span data-ttu-id="a4c11-326">Cette valeur renvoyée représente de manière ambiguë un objet non sérialisable tentant d'être affecté au contexte de message.</span><span class="sxs-lookup"><span data-stu-id="a4c11-326">This return value ambiguously represents a non-serializable object attempting to be assigned the message context.</span></span>