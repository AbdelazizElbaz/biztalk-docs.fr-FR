---
title: "Traitement par lot des Messages pour le traitement de réception | Documents Microsoft"
ms.custom: 
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: 
ms.suite: 
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: 32bf0b70-e9d1-4fab-9c74-160e51390700
caps.latest.revision: "8"
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: ef14179c1af460afc516b7fa331ee30a758219c3
ms.sourcegitcommit: cb908c540d8f1a692d01dc8f313e16cb4b4e696d
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 09/20/2017
---
# <a name="batching-messages-for-receive-processing"></a><span data-ttu-id="5a4b4-102">Traitement par lot des messages pour le traitement de réception</span><span class="sxs-lookup"><span data-stu-id="5a4b4-102">Batching Messages for Receive Processing</span></span>
## <a name="batch-callbacks"></a><span data-ttu-id="5a4b4-103">Rappels en lot</span><span class="sxs-lookup"><span data-stu-id="5a4b4-103">Batch Callbacks</span></span>  
 <span data-ttu-id="5a4b4-104">Les lots envoyés par les adaptateurs de réception au moteur de messagerie étant traités de façon asynchrone,</span><span class="sxs-lookup"><span data-stu-id="5a4b4-104">Batches submitted by receive adapters to the Messaging Engine are processed asynchronously.</span></span> <span data-ttu-id="5a4b4-105">l'adaptateur a besoin d'un mécanisme pour lier un rappel à un état quelconque au sein de l'adaptateur afin de pouvoir être notifié du succès ou de l'échec de l'opération et réaliser les actions de nettoyage nécessaires.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-105">Therefore the adapter needs a mechanism to tie a callback to some state in the adapter so it can be notified of success or failure and perform any necessary cleanup actions.</span></span> <span data-ttu-id="5a4b4-106">La sémantique des rappels étant souple, les adaptateurs peuvent utiliser une des trois approches possibles ou les combiner.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-106">The callback semantics are flexible such that adapters can use one or a combination of three approaches.</span></span> <span data-ttu-id="5a4b4-107">Il s'agit des paramètres suivants :</span><span class="sxs-lookup"><span data-stu-id="5a4b4-107">These are:</span></span>  
  
-   <span data-ttu-id="5a4b4-108">Tous les rappels sont effectuées sur la même instance d’objet qui implémente **IBTBatchCallBack**.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-108">All callbacks are made on the same object instance that implements **IBTBatchCallBack**.</span></span>  
  
-   <span data-ttu-id="5a4b4-109">Le cookie passé au moteur au moment où une requête de nouveau lot est effectuée est utilisé pour mettre le rappel en corrélation avec l'état au sein des adaptateurs.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-109">The cookie passed into the engine when requesting a new batch is used to correlate the callback to the state in the adapters.</span></span>  
  
-   <span data-ttu-id="5a4b4-110">Il existe un objet de rappel différent pour chaque lot qui implémente **IBTBatchCallBack**.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-110">There is a different callback object for each batch that implements **IBTBatchCallBack**.</span></span> <span data-ttu-id="5a4b4-111">Ici, chaque objet détient son propre état privé.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-111">Here each object holds its own private state.</span></span>  
  
 <span data-ttu-id="5a4b4-112">Lorsque le lot a été traité, l’adaptateur est rappelé sur son implémentation de **IBTBatchCallBack.BatchComplete**.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-112">When the batch has been processed, the adapter is called back on its implementation of **IBTBatchCallBack.BatchComplete**.</span></span> <span data-ttu-id="5a4b4-113">C'est le premier paramètre qui indique l'état global du lot, à savoir le paramètre HRESULT.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-113">The overall status of the batch is indicated by the first parameter, the HRESULT status.</span></span> <span data-ttu-id="5a4b4-114">Si la valeur de ce paramètre est supérieure ou égale à zéro, le lot a correctement été traité dans la mesure où le moteur devient propriétaire des données et où l'adaptateur est libre de supprimer ces données du câble.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-114">If this value is greater than or equal to zero, then the batch was successful in the sense that the engine has ownership of the data and the adapter is free to delete that data from the wire.</span></span> <span data-ttu-id="5a4b4-115">Un état négatif indique que le lot a échoué : aucune des opérations du lot ont réussi et que l’adaptateur est responsable de la gestion de l’échec.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-115">A negative status indicates that the batch failed: None of the operations in the batch were successful and the adapter is responsible for handling the failure.</span></span>  
  
 <span data-ttu-id="5a4b4-116">Si le lot a échoué, l'adaptateur a besoin de savoir quel élément de quelle opération a échoué.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-116">If the batch failed, then the adapter needs to know which item in which operation failed.</span></span> <span data-ttu-id="5a4b4-117">Supposons, par exemple, que l'adaptateur était en train de lire 20 fichiers provenant du disque et de les envoyer en un seul lot vers [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="5a4b4-117">For example, suppose that the adapter was reading 20 files from disk and submitting them into [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] using a single batch.</span></span> <span data-ttu-id="5a4b4-118">Si le dixième fichier a été endommagé, la carte doit suspendre qu’un fichier et de renvoyer les 19 restants.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-118">If the tenth file was corrupted, the adapter would need to suspend that one file and resubmit the remaining 19.</span></span> <span data-ttu-id="5a4b4-119">Ces informations sont disponibles à l’adaptateur dans les deuxième et troisième paramètres :`opCount` (nombre d’opérations) de type short et `operationStatus`, qui est de type BTBatchOperationStatus [].</span><span class="sxs-lookup"><span data-stu-id="5a4b4-119">This information is available to the adapter in the second and third parameters—`opCount` (operation count) of type short and `operationStatus`, which is of type BTBatchOperationStatus[].</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="5a4b4-120">Au sein d'un même objet de lot, un message ne doit jamais être envoyé plus d'une fois,</span><span class="sxs-lookup"><span data-stu-id="5a4b4-120">On a single batch object you should never submit a message more than once.</span></span> <span data-ttu-id="5a4b4-121">au risque de provoquer des erreurs au niveau du moteur.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-121">Submitting the same message object more than once on the same batch will result in engine errors.</span></span>  
  
 <span data-ttu-id="5a4b4-122">Le nombre d’opérations indique combien de types d’opérations dans le lot (la taille de la **BTBatchOperationStatus** tableau).</span><span class="sxs-lookup"><span data-stu-id="5a4b4-122">The operation count indicates how many types of operations were in the batch (the size of the **BTBatchOperationStatus** array).</span></span> <span data-ttu-id="5a4b4-123">Chaque élément du tableau d'état des opérations correspond à un type d'opération donné.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-123">Each element in the operation status array corresponds to a given operation type.</span></span> <span data-ttu-id="5a4b4-124">À l’aide de la **BTBatchOperationStatus** tableau, l’adaptateur peut déterminer quel élément d’une opération donnée a échoué en consultant le **BTBatchOperationStatus.MessageStatus** tableau pour HRESULT négatif valeurs indiquant l’échec.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-124">By using the **BTBatchOperationStatus** array, the adapter can determine which item in a given operation failed by looking at the **BTBatchOperationStatus.MessageStatus** array for negative HRESULT values signifying failure.</span></span> <span data-ttu-id="5a4b4-125">Dans le scénario ci-dessus, l'adaptateur crée un nouveau lot qui contient 19 envois de message et un message suspendu.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-125">In the scenario above, the adapter creates a new batch containing 19 message submits and one message suspend.</span></span>  
  
 <span data-ttu-id="5a4b4-126">Le fragment de code ci-dessous montre comment l'adaptateur demande un nouveau lot auprès du moteur par l'intermédiaire de son proxy de transport et envoie un seul message au moteur à l'aide de l'approche par cookie.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-126">The following code fragment shows how an adapter requests a new batch from the engine through its transport proxy and submits a single message into the engine using the cookie approach.</span></span> <span data-ttu-id="5a4b4-127">Le moteur de messagerie appelle la **BatchComplete** le rappel de lot lorsqu’il a terminé le traitement de la totalité du traitement de la méthode de messages envoyés.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-127">The Messaging Engine calls the **BatchComplete** method as the batch callback when it has completed processing the entire batch of submitted messages.</span></span>  
  
```  
using Microsoft.BizTalk.TransportProxy.Interop;  
using Microsoft.BizTalk.Message.Interop;  
  
public class MyAdapter :   
                  IBTTransport,   
                  IBTTransportConfig,   
                  IBTTransportControl,  
                  IPersistPropertyBag,   
                  IBaseComponent,  
                  IBTBatchCallBack  
{  
      private IBTTransportProxy _tp;  
  
      public void BatchComplete(      
            Int32                         status,   
            Int16                         opCount,   
            BTBatchOperationStatus[]      operationStatus,   
            System.Object                 callbackCookie)  
      {  
            // Use cookie to correlate callback with work done,  
            // in this example the batch is to submit a single  
            // file the name of which will be in the  
            // callbackCookie  
            string fileName = (string)callbackCookie;  
            if ( status >= 0 )  
                  // DeleteFile from disc  
                  File.Delete(fileName);          
            else  
                  // Rename file to fileName.bad  
                  File.Move(fileName, fileName + ".bad");  
      }  
  
      private void SubmitMessage(  
            IBaseMessage                  msg,   
            string                        fileName)  
      {  
            // Note: Pass in the filename as the cookie  
            IBTTransportBatch batch =   
                  _tp.GetBatch(this, (object)fileName);  
  
            // Add msg to batch for submitting   
            batch.SubmitMessage(msg);   
  
            // Process this batch  
            batch.Done(null);  
      }  
}  
```  
  
 <span data-ttu-id="5a4b4-128">Le [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] kit SDK inclut des exemples pour les adaptateurs suivants : fichier, HTTP, MSMQ et l’adaptateur transactionnel.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-128">The [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] SDK includes samples for the following adapters: File, HTTP, MSMQ, and the Transactional Adapter.</span></span> <span data-ttu-id="5a4b4-129">Tous ces adaptateurs reposent sur un bloc de construction commun appelé BaseAdapter.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-129">All of these adapters are built on top of a common building block called the BaseAdapter.</span></span> <span data-ttu-id="5a4b4-130">La version 1.0.1 de BaseAdapter inclut tout le code nécessaire à l'analyse de l'état des opérations et à la régénération des nouveaux lots à envoyer.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-130">Version 1.0.1 of the BaseAdapter includes all of the relevant code to parse the operation status and rebuild a new batch to submit.</span></span>  
  
## <a name="race-condition"></a><span data-ttu-id="5a4b4-131">Condition d'engorgement</span><span class="sxs-lookup"><span data-stu-id="5a4b4-131">Race Condition</span></span>  
 <span data-ttu-id="5a4b4-132">Les deux tâches que sont la résolution des erreurs et la décision concernant le résultat final d'un lot envoyé sont en apparence assez simples. En fait, elles s'appuient sur des informations provenant de plusieurs threads :</span><span class="sxs-lookup"><span data-stu-id="5a4b4-132">The two tasks of resolving errors and deciding the final outcome of a submitted batch seem simple enough, but in fact they rely on information from different threads:</span></span>  
  
-   <span data-ttu-id="5a4b4-133">L’adaptateur traite les erreurs basées sur les informations passées par [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] à l’adaptateur **BatchComplete** méthode de rappel.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-133">The adapter processes errors based on information passed by [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] to the adapter's **BatchComplete** callback method.</span></span> <span data-ttu-id="5a4b4-134">Ce rappel s'exécute sur le thread de l'adaptateur.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-134">This callback executes on the adapter's thread.</span></span>  
  
-   <span data-ttu-id="5a4b4-135">**DTCCommitConfirm** est une méthode de la **IBTDTCCommitConfirm** objet.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-135">**DTCCommitConfirm** is a method on the **IBTDTCCommitConfirm** object.</span></span> <span data-ttu-id="5a4b4-136">Une instance de la **IBTDTCCommitConfirm** est retourné par le lot **IBTTransportBatch::Done** appeler.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-136">An instance of the **IBTDTCCommitConfirm** object is returned by the batch **IBTTransportBatch::Done** call.</span></span> <span data-ttu-id="5a4b4-137">Cette instance est sur le même thread que le **IBTTransportBatch::Done** appeler, lequel est différent du thread de rappel de l’adaptateur.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-137">This instance is on the same thread as the **IBTTransportBatch::Done** call, which is different from the adapter's callback thread.</span></span>  
  
 <span data-ttu-id="5a4b4-138">Pour chaque appel que l’adaptateur effectue vers **IBTTransportBatch::Done** le moteur de messagerie effectue un appel correspondant à la méthode de rappel **BatchComplete** dans un thread distinct pour signaler le résultat de la envoi du lot.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-138">For every call that the adapter makes to **IBTTransportBatch::Done** the Messaging Engine makes a corresponding call to the callback method **BatchComplete** in a separate thread to report the result of the batch submission.</span></span> <span data-ttu-id="5a4b4-139">Dans **BatchComplete** l’adaptateur doit valider ou annuler la transaction selon que le lot ayant réussi ou échoué.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-139">In **BatchComplete** the adapter needs to commit or roll back the transaction based on whether the batch passed or failed.</span></span> <span data-ttu-id="5a4b4-140">Dans les deux cas, l’adaptateur doit appeler **DTCCommitConfirm** pour signaler l’état de la transaction.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-140">In either case, the adapter should then call **DTCCommitConfirm** to report the status of the transaction.</span></span>  
  
 <span data-ttu-id="5a4b4-141">Il existe une condition d’engorgement possible car implémentation de l’adaptateur de **BatchComplete** peut supposer que le **IBTDTCCommitConfirm** objet retourné par **IBTTransportBatch::Done** est toujours disponible lorsque **BatchComplete** s’exécute.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-141">A possible race condition exists because the adapter’s implementation of **BatchComplete** can assume that the **IBTDTCCommitConfirm** object returned by **IBTTransportBatch::Done** is always available when **BatchComplete** executes.</span></span> <span data-ttu-id="5a4b4-142">Toutefois, **BatchComplete** peut être appelée dans un thread séparé de moteur de messagerie, avant même que **IBTTransportBatch::Done** retourne.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-142">However, **BatchComplete** can be called in a separate Messaging Engine thread, even before **IBTTransportBatch::Done** returns.</span></span> <span data-ttu-id="5a4b4-143">Il est possible de qui lorsque l’adaptateur tente d’accéder à la **IBTDTCCommitConfirm** objet dans le cadre de la **BatchComplete** implémentation, ici, est une violation d’accès parce que l’appel de thread n’est plus Il existe.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-143">It is possible that when the adapter tries to access the **IBTDTCCommitConfirm** object as a part of the **BatchComplete** implementation, there is an access violation because that calling thread no longer exists.</span></span> <span data-ttu-id="5a4b4-144">Utilisez la solution suivante pour éviter cette condition.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-144">Use the following solution to avoid this condition.</span></span>  
  
 <span data-ttu-id="5a4b4-145">L'exemple suivant permet de résoudre le problème à l'aide d'un événement.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-145">In the following example, the problem is solved by using an event.</span></span> <span data-ttu-id="5a4b4-146">Ici, le pointeur d'interface fait l'objet d'un accès par l'intermédiaire d'une propriété qui fait appel à un événement.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-146">Here the interface pointer is accessed through a property that uses the event.</span></span> <span data-ttu-id="5a4b4-147">La méthode get attend toujours que la méthode set soit terminée avant de poursuivre.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-147">The get always waits for the set to complete before proceeding.</span></span>  
  
```  
protected IBTDTCCommitConfirm CommitConfirm  
{  
      set  
      {  
            this.commitConfirm = value;  
            this.commitConfirmEvent.Set();  
      }  
      get  
      {  
            this.commitConfirmEvent.WaitOne();  
            return this.commitConfirm;  
      }  
}  
protected IBTDTCCommitConfirm commitConfirm = null;  
private ManualResetEvent commitConfirmEvent = new ManualResetEvent(false);  
```  
  
## <a name="batch-status-codes"></a><span data-ttu-id="5a4b4-148">Codes d'état des lots</span><span class="sxs-lookup"><span data-stu-id="5a4b4-148">Batch Status Codes</span></span>  
 <span data-ttu-id="5a4b4-149">Le code d'état global du lot indique le résultat du lot.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-149">The overall batch status code indicates the outcome of the batch.</span></span> <span data-ttu-id="5a4b4-150">L'état de l'opération donne le code d'état de l'envoi pour chaque élément de message.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-150">The operation status gives the submission status code for individual message items.</span></span> <span data-ttu-id="5a4b4-151">Les lots peuvent échouer pour diverses raisons.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-151">Batches can fail for various reasons.</span></span> <span data-ttu-id="5a4b4-152">Une erreur liée à la sécurité peut se produire ou le message peut avoir été envoyé au moment où le moteur était en cours d'arrêt.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-152">There might be a security-related failure, or the message might have been submitted when the engine was shutting down.</span></span> <span data-ttu-id="5a4b4-153">(Généralement, lorsque le moteur s'arrête, il n'accepte pas de nouvelle tâche mais permet aux tâches in-process de se terminer.) Le tableau suivant répertorie certaines valeurs courantes du paramètre HRESULT renvoyées soit dans l'état du lot, soit dans l'état de l'opération.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-153">(Typically when the engine shuts down it does not accept any new work but does allow in-process work to be completed.) The following table indicates some common HRESULT values that are returned either in the batch status or the operation status.</span></span> <span data-ttu-id="5a4b4-154">Il indique également s'il s'agit d'un code de réussite ou d'échec.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-154">It also indicates whether these are success or failure codes.</span></span> <span data-ttu-id="5a4b4-155">La manipulation de ces codes est décrite plus en détail dans [comment gérer les défaillances d’adaptateur](../core/how-to-handle-adapter-failures.md).</span><span class="sxs-lookup"><span data-stu-id="5a4b4-155">The proper handling of these codes is described more fully in [How to Handle Adapter Failures](../core/how-to-handle-adapter-failures.md).</span></span>  
  
|<span data-ttu-id="5a4b4-156">Code (défini dans la classe BTTransportProxy)</span><span class="sxs-lookup"><span data-stu-id="5a4b4-156">Code (defined in the class BTTransportProxy)</span></span>|<span data-ttu-id="5a4b4-157">Code de réussite/d'échec</span><span class="sxs-lookup"><span data-stu-id="5a4b4-157">Success/failure code</span></span>|<span data-ttu-id="5a4b4-158"> Description</span><span class="sxs-lookup"><span data-stu-id="5a4b4-158">Description</span></span>|  
|----------------------------------------------------|---------------------------|-----------------|  
|<span data-ttu-id="5a4b4-159">BTS_S_EPM_SECURITY_CHECK_FAILED</span><span class="sxs-lookup"><span data-stu-id="5a4b4-159">BTS_S_EPM_SECURITY_CHECK_FAILED</span></span>|<span data-ttu-id="5a4b4-160">Réussi</span><span class="sxs-lookup"><span data-stu-id="5a4b4-160">Success</span></span>|<span data-ttu-id="5a4b4-161">Le port a été configuré pour effectuer une vérification de sécurité et supprimer les messages dont l'authentification a échoué.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-161">The port was configured to perform a security check and drop messages that failed authentication.</span></span> <span data-ttu-id="5a4b4-162">Les adaptateurs ne devraient pas suspendre les lots qui renvoient ce code d'état.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-162">Adapters should not suspend batches that return this status code.</span></span>|  
|<span data-ttu-id="5a4b4-163">BTS_S_EPM_MESSAGE_SUSPENDED</span><span class="sxs-lookup"><span data-stu-id="5a4b4-163">BTS_S_EPM_MESSAGE_SUSPENDED</span></span>|<span data-ttu-id="5a4b4-164">Réussi</span><span class="sxs-lookup"><span data-stu-id="5a4b4-164">Success</span></span>|<span data-ttu-id="5a4b4-165">Indique qu'un ou que plusieurs messages ont été suspendus et que le moteur est propriétaire des données.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-165">Indicates that one or more messages were suspended, and the engine has ownership of the data.</span></span> <span data-ttu-id="5a4b4-166">Il s'agit d'un code de réussite dans la mesure où le moteur de messagerie a accepté les messages envoyés.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-166">It is a success code in that the Messaging Engine has accepted the message submission.</span></span>|  
|<span data-ttu-id="5a4b4-167">E_BTS_URL_DISALLOWED</span><span class="sxs-lookup"><span data-stu-id="5a4b4-167">E_BTS_URL_DISALLOWED</span></span>|<span data-ttu-id="5a4b4-168">Failure</span><span class="sxs-lookup"><span data-stu-id="5a4b4-168">Failure</span></span>|<span data-ttu-id="5a4b4-169">Un message a été envoyé avec un non valide **InboundTransportLocation**.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-169">A message was submitted with an invalid **InboundTransportLocation**.</span></span>|  
  
## <a name="batch-operations"></a><span data-ttu-id="5a4b4-170">Opérations de traitement par lot</span><span class="sxs-lookup"><span data-stu-id="5a4b4-170">Batch Operations</span></span>  
 <span data-ttu-id="5a4b4-171">Le tableau suivant répertorie les méthodes membres et les opérations de la **IBTTransportBatch** de l’objet que l’adaptateur utilise pour ajouter des tâches à un lot donné.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-171">The following table details the member methods and operations of the **IBTTransportBatch** object that the adapter uses to add work to a given batch.</span></span>  
  
|<span data-ttu-id="5a4b4-172">Nom de la méthode</span><span class="sxs-lookup"><span data-stu-id="5a4b4-172">Method name</span></span>|<span data-ttu-id="5a4b4-173">Type d'opération</span><span class="sxs-lookup"><span data-stu-id="5a4b4-173">Operation type</span></span>|<span data-ttu-id="5a4b4-174"> Description</span><span class="sxs-lookup"><span data-stu-id="5a4b4-174">Description</span></span>|  
|-----------------|--------------------|-----------------|  
|<span data-ttu-id="5a4b4-175">**SubmitMessage**</span><span class="sxs-lookup"><span data-stu-id="5a4b4-175">**SubmitMessage**</span></span>|<span data-ttu-id="5a4b4-176">Envoyer</span><span class="sxs-lookup"><span data-stu-id="5a4b4-176">Submit</span></span>|<span data-ttu-id="5a4b4-177">Envoie un message au moteur.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-177">Submits a message into the engine.</span></span>|  
|<span data-ttu-id="5a4b4-178">**SubmitResponseMessage**</span><span class="sxs-lookup"><span data-stu-id="5a4b4-178">**SubmitResponseMessage**</span></span>|<span data-ttu-id="5a4b4-179">Envoyer</span><span class="sxs-lookup"><span data-stu-id="5a4b4-179">Submit</span></span>|<span data-ttu-id="5a4b4-180">Envoie un message de réponse au moteur.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-180">Submits a response message into the engine.</span></span> <span data-ttu-id="5a4b4-181">Il s'agit d'un message de réponse d'une paire sollicitation-réponse.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-181">This is the response message in a solicit-response pair.</span></span>|  
|<span data-ttu-id="5a4b4-182">**DeleteMessage**</span><span class="sxs-lookup"><span data-stu-id="5a4b4-182">**DeleteMessage**</span></span>|<span data-ttu-id="5a4b4-183">DELETE</span><span class="sxs-lookup"><span data-stu-id="5a4b4-183">Delete</span></span>|<span data-ttu-id="5a4b4-184">Supprime un message qu'un adaptateur a correctement transmis sur le câble à l'aide d'un envoi non bloquant.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-184">Deletes a message that an adapter has successfully transmitted over the wire using a non-blocking send.</span></span> <span data-ttu-id="5a4b4-185">Les adaptateurs qui utilisent des envois bloquants n’avez pas besoin d’appeler cette méthode, car le moteur de messagerie va entraîner sa suppression sur le nom de l’adaptateur si l’adaptateur retourne `true` de **TransmitMesssage**.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-185">Adapters that use blocking sends do not need to call this method because the Messaging Engine will delete it on the adapter's behalf if the adapter returns `true` from **TransmitMesssage**.</span></span>|  
|<span data-ttu-id="5a4b4-186">**MoveToSuspendQ**</span><span class="sxs-lookup"><span data-stu-id="5a4b4-186">**MoveToSuspendQ**</span></span>|<span data-ttu-id="5a4b4-187">MoveToSuspendQ</span><span class="sxs-lookup"><span data-stu-id="5a4b4-187">MoveToSuspendQ</span></span>|<span data-ttu-id="5a4b4-188">Place un message dans la file d'attente de messages interrompus.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-188">Moves a message into the Suspended queue.</span></span>|  
|<span data-ttu-id="5a4b4-189">**Soumettez à nouveau**</span><span class="sxs-lookup"><span data-stu-id="5a4b4-189">**Resubmit**</span></span>|<span data-ttu-id="5a4b4-190">Resubmit</span><span class="sxs-lookup"><span data-stu-id="5a4b4-190">Resubmit</span></span>|<span data-ttu-id="5a4b4-191">Demande qu'un message fasse l'objet d'un nouvel essai de transmission plus tard.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-191">Requests that a message should be retried for transmission at a later time.</span></span> <span data-ttu-id="5a4b4-192">Cette méthode est généralement appelée après qu'une tentative de transmission a échoué.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-192">This is typically called after a transmission attempt has failed.</span></span>|  
|<span data-ttu-id="5a4b4-193">**MoveToNextTransport**</span><span class="sxs-lookup"><span data-stu-id="5a4b4-193">**MoveToNextTransport**</span></span>|<span data-ttu-id="5a4b4-194">MoveToNextTransport</span><span class="sxs-lookup"><span data-stu-id="5a4b4-194">MoveToNextTransport</span></span>|<span data-ttu-id="5a4b4-195">Demande qu'un message soit transmis à l'aide de son transport secondaire.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-195">Requests that a message be transmitted using its backup transport.</span></span> <span data-ttu-id="5a4b4-196">Cette méthode est généralement appelée lorsque le nombre maximal de tentatives est atteint.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-196">Typically called after all retries have been exhausted.</span></span> <span data-ttu-id="5a4b4-197">En l'absence de transport secondaire, cette méthode échoue.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-197">If no backup transport is present this method will fail</span></span>|  
|<span data-ttu-id="5a4b4-198">**SubmitRequestMessage**</span><span class="sxs-lookup"><span data-stu-id="5a4b4-198">**SubmitRequestMessage**</span></span>|<span data-ttu-id="5a4b4-199">SubmitRequest</span><span class="sxs-lookup"><span data-stu-id="5a4b4-199">SubmitRequest</span></span>|<span data-ttu-id="5a4b4-200">Envoie un message de requête.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-200">Submits a request message.</span></span> <span data-ttu-id="5a4b4-201">Il s'agit d'un message de requête d'une paire requête-réponse.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-201">This is a request message in a request-response pair.</span></span>|  
|<span data-ttu-id="5a4b4-202">**CancelRequestForResponse**</span><span class="sxs-lookup"><span data-stu-id="5a4b4-202">**CancelRequestForResponse**</span></span>|<span data-ttu-id="5a4b4-203">CancelRequestForResponse</span><span class="sxs-lookup"><span data-stu-id="5a4b4-203">CancelRequestForResponse</span></span>|<span data-ttu-id="5a4b4-204">Notifie le moteur que l'adaptateur ne souhaite plus attendre le message de réponse d'une paire requête-réponse.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-204">Notifies the engine that the adapter no longer wishes to wait for the response message in a request-response pair.</span></span>|  
|<span data-ttu-id="5a4b4-205">**Désactiver**</span><span class="sxs-lookup"><span data-stu-id="5a4b4-205">**Clear**</span></span>|<span data-ttu-id="5a4b4-206">N/A</span><span class="sxs-lookup"><span data-stu-id="5a4b4-206">NA</span></span>|<span data-ttu-id="5a4b4-207">Supprime toutes les tâches du lot.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-207">Clears all work from the batch.</span></span>|  
|<span data-ttu-id="5a4b4-208">**Terminé**</span><span class="sxs-lookup"><span data-stu-id="5a4b4-208">**Done**</span></span>|<span data-ttu-id="5a4b4-209">N/A</span><span class="sxs-lookup"><span data-stu-id="5a4b4-209">NA</span></span>|<span data-ttu-id="5a4b4-210">Envoie un lot de messages à traiter au moteur.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-210">Submits a batch of messages to the engine for processing.</span></span>|  
  
## <a name="batch-management"></a><span data-ttu-id="5a4b4-211">Gestion des lots</span><span class="sxs-lookup"><span data-stu-id="5a4b4-211">Batch Management</span></span>  
 <span data-ttu-id="5a4b4-212">Les lots sont implémentés en code natif au sein du moteur de messagerie.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-212">Batches are implemented in native code in the Messaging Engine.</span></span> <span data-ttu-id="5a4b4-213">C'est pourquoi un adaptateur écrit en code géré devrait libérer le wrapper RCW (Runtime Callable Wrapper) pour le lot après avoir terminé le traitement du lot.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-213">For this reason an adapter written in managed code should release the runtime callable wrapper (RCW) for the batch after it has finished with the batch.</span></span> <span data-ttu-id="5a4b4-214">Cette opération est effectuée en code géré à l’aide de la **Marshal.ReleaseComObject** API.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-214">This is done in managed code by using the **Marshal.ReleaseComObject** API.</span></span> <span data-ttu-id="5a4b4-215">Il est important de souligner que cette API doit être appelée dans une boucle while tant que le nombre de références renvoyé atteigne zéro.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-215">It is important to remember that this API should be called in a while loop until the returned reference count reaches zero.</span></span>  
  
 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]<span data-ttu-id="5a4b4-216"> traite de façon synchrone les messages d'un lot.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-216"> processes messages synchronously within a batch.</span></span> <span data-ttu-id="5a4b4-217">De nombreux lots pouvant être traités en même temps, ceci peut être une occasion pour optimiser l'adaptateur en ajustant la taille de lot dans le domaine d'application.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-217">Many batches may be processed concurrently, which may provide an opportunity for some optimization in the adapter by adjusting the batch size in the application domain.</span></span> <span data-ttu-id="5a4b4-218">Supposons, par exemple, que vous voulez traiter tous les fichiers d'un FTP (jusqu'à ce qu'une limite donnée soit atteinte)</span><span class="sxs-lookup"><span data-stu-id="5a4b4-218">For example, you might process all the files on an FTP site (until some limit is hit).</span></span> <span data-ttu-id="5a4b4-219">ou dans le cas de SAP, vous voulez traiter un seul flux dans un nombre de messages envoyés en tant que lot.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-219">In the case of SAP you might process a single stream into a number of messages that are then submitted as a batch.</span></span>  
  
 <span data-ttu-id="5a4b4-220">Le lot utilisé par un adaptateur pour repasser les opérations à [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] n'a pas nécessairement besoin de correspondre exactement à la liste de messages que [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] donne à l'adaptateur.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-220">The batch used by an adapter to pass operations back to [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] does not need to exactly correspond to the list of messages that [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] gives to the adapter.</span></span> <span data-ttu-id="5a4b4-221">En d’autres termes, lorsque envois transactionnels, vous devez fractionner les opérations de renvoi **MoveToNextTransport** et **MoveToSuspendQ** dans des lots distincts.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-221">In other words, when doing transactional sends you must split the resubmit operations **MoveToNextTransport** and **MoveToSuspendQ** into separate batches.</span></span> <span data-ttu-id="5a4b4-222">De nombreux adaptateurs trient les lots de messages envoyés destinés à plusieurs points de terminaison dans des listes de messages distinctes qui feront l'objet de davantage de traitement.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-222">Many adapters sort a batch of messages that have been submitted for multiple endpoints into separate lists of messages for further processing.</span></span>  
  
 <span data-ttu-id="5a4b4-223">En résumé, dans[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)], il n'existe aucune règle (outre celles associées à la transaction) associée au traitement par lot des messages.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-223">The point is that there are no rules (besides those associated with the transaction) associated with message batching in [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)].</span></span> <span data-ttu-id="5a4b4-224">Le traitement par lot est simplement un moyen spécifique à l'implémentation dont dispose l'adaptateur pour découper les messages allant vers [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] ou sortant de celui-ci.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-224">Batching is simply an implementation-specific way for the adapter to chunk messages into and out of [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)].</span></span>  
  
 <span data-ttu-id="5a4b4-225">Un adaptateur peut créer des lots de messages en regroupant des lots plus petits que [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] a fourni en lot volumineux en réponse à [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="5a4b4-225">An adapter can batch messages from multiple smaller batches that [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] has given it into a larger batch for the response to [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)].</span></span> <span data-ttu-id="5a4b4-226">Vous pouvez optimiser de manière sensible les adaptateurs transactionnels amenés à traiter de grands nombres de très petits messages.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-226">This might be a significant optimization in transactional adapters that are dealing with large numbers of very small messages.</span></span> <span data-ttu-id="5a4b4-227">Cela réduit le rapport nombre de transactions par message.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-227">It minimizes the "total number of transactions per message" ratio.</span></span>  
  
 <span data-ttu-id="5a4b4-228">En règle générale, [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] produit côté envoi des lots comportant entre 5 et 10 messages.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-228">Typically [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] produces send-side batches of between 5 and 10 messages.</span></span> <span data-ttu-id="5a4b4-229">S'il s'agit de très petits messages, un adaptateur peut regrouper jusqu'à 100 messages dans un lot avant de renvoyer un lot transactionnel de suppressions à [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="5a4b4-229">If these are very small messages, an adapter might batch up to 100 messages or more before it submits a transactional batch of deletes back to [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)].</span></span> <span data-ttu-id="5a4b4-230">Une telle optimisation n'est pas facile à implémenter. Vous devez vous assurer que les messages ne restent jamais coincés dans la mémoire de l'adaptateur en attendant indéfiniment qu'un seuil quelconque soit atteint.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-230">An optimization like this is not easy to implement; you must make sure that messages never get stuck in the adapter memory, waiting endlessly for some threshold to be met.</span></span>  
  
 <span data-ttu-id="5a4b4-231">L'importance du traitement par lot est visible au niveau des statistiques de performances de [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] concernant les adaptateurs à débit élevé, tels que MQSeries.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-231">The significance of batching can be seen in the performance numbers for [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] for the high-throughput adapters like MQSeries.</span></span> <span data-ttu-id="5a4b4-232">Dans le cas de ces adaptateurs, les messages sont reçus au moins deux fois plus souvent qu'ils ne sont envoyés.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-232">In these adapters, messages are received at least twice as often as they are sent.</span></span> <span data-ttu-id="5a4b4-233">Par défaut, l'adaptateur de réception utilise des lots de 100 messages alors que l'adaptateur d'envoi utilise les lots [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] par défaut qui lui sont donnés.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-233">By default the receive adapter uses batches of 100 messages and the send adapter uses the default [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] batch it is given.</span></span>  
  
## <a name="transactional-batches"></a><span data-ttu-id="5a4b4-234">Lots transactionnels</span><span class="sxs-lookup"><span data-stu-id="5a4b4-234">Transactional Batches</span></span>  
 <span data-ttu-id="5a4b4-235">Lorsque vous écrivez le code d'un adaptateur qui crée un objet transactionnel et le remet à [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)], vous prenez la responsabilité que le code :</span><span class="sxs-lookup"><span data-stu-id="5a4b4-235">When you write an adapter that creates a transaction object and hands it to [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)], you are accepting responsibility for writing code that does the following:</span></span>  
  
-   <span data-ttu-id="5a4b4-236">Décide du résultat final de l’opération de traitement par lots : pour valider ou pour terminer la transaction.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-236">Decides the final outcome of the batch operation: to either commit or end the transaction.</span></span> <span data-ttu-id="5a4b4-237">Cette décision peut dépendre d'autres branches transactionnelles au sein de l'étendue de cette transaction qui ne dépendent pas de [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]. Il peut s'agir notamment de l'écriture dans une file d'attente Message Queuing (MSMQ) ou d'une opération de base de données transactionnelle ;</span><span class="sxs-lookup"><span data-stu-id="5a4b4-237">This may depend upon other transactional branches within the scope of this one transaction that are not [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] dependent, such as writing to an Message Queuing (MSMQ) queue or a transactional database operation.</span></span>  
  
-   <span data-ttu-id="5a4b4-238">Informe [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] du résultat final en appelant le **IBTDTCCommitConfirm.DTCCommitConfirm** (méthode).</span><span class="sxs-lookup"><span data-stu-id="5a4b4-238">Informs [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] of the final outcome by calling the **IBTDTCCommitConfirm.DTCCommitConfirm** method.</span></span> <span data-ttu-id="5a4b4-239">Renvoie `true` pour indiquer la réussite de la validation de la transaction et `false` pour indiquer l'échec et l'annulation de la transaction.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-239">Returning `true` indicates a successful commit of the transaction; returning `false` signifies failure and rollback of the transaction.</span></span>  
  
 <span data-ttu-id="5a4b4-240">L'adaptateur doit informer [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] du résultat final de la transaction pour pouvoir tenir à jour ses données de suivi internes.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-240">The adapter must inform [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] about the final outcome of the transaction to maintain its internal tracking data.</span></span> <span data-ttu-id="5a4b4-241">L’adaptateur informe [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] du résultat final en appelant **DTCCommitConfirm**.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-241">The adapter informs [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] of the outcome by calling **DTCCommitConfirm**.</span></span> <span data-ttu-id="5a4b4-242">S'il ne le fait pas, une fuite de mémoire sensible se produit et la transaction MSDTC expire, puis échoue bien que ses opérations aient réussi.</span><span class="sxs-lookup"><span data-stu-id="5a4b4-242">If the adapter does not do this, a significant memory leak occurs and the MSDTC transaction could time out and fail despite its operations completing successfully.</span></span>